<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Data Management</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0D47A1;
            --secondary-color: #1976D2;
            --accent-color: #FF5722;
            --background-color: #F4F6F8;
            --surface-color: #FFFFFF;
            --error-color: #D32F2F;
            --success-color: #388E3C;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #E0E0E0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-weight: 500;
        }
        .header .user-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Auth Container */
        #auth-container {
            padding: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #auth-container h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        #auth-container p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        #auth-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #auth-form input {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        #auth-form input:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        #auth-form button {
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #auth-form button:hover {
            background-color: var(--primary-color);
        }
        #auth-error, #auth-success {
            margin-top: 15px;
            font-weight: 500;
        }
        #auth-error { color: var(--error-color); }
        #auth-success { color: var(--success-color); }
        .auth-link {
            margin-top: 20px;
            color: var(--text-secondary);
        }
        .auth-link a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .auth-link a:hover {
            text-decoration: underline;
        }

        /* Modal for Sign Up */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            position: relative;
        }
        .close {
            color: var(--text-secondary);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: var(--text-primary); }

        /* Data Panel */
        #data-panel { display: none; flex-direction: column; height: 80vh; }
        .controls { 
            padding: 20px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color); 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        .search-container { 
            display: flex; 
            align-items: center; 
            background-color: var(--background-color); 
            border-radius: 8px; 
            padding: 8px 15px; 
            width: 300px; 
        }
        .search-container i { color: var(--text-secondary); margin-right: 10px; }
        #search-input { border: none; background: none; outline: none; width: 100%; font-size: 16px; }
        .action-buttons { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        .action-buttons button { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: background-color 0.3s, transform 0.2s; 
        }
        .action-buttons button:hover { transform: translateY(-2px); }
        #logout-btn { background-color: var(--error-color); color: white; }
        
        /* Download Dropdown Styles */
        .download-dropdown {
            position: relative;
            display: inline-block;
        }
        .download-dropdown button {
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .download-dropdown button:hover {
            background-color: #E64A19;
            transform: translateY(-2px);
        }
        .download-dropdown button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }
        .download-dropdown button:disabled:hover {
            background-color: var(--text-secondary);
            transform: none;
        }
        .download-dropdown .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--surface-color);
            min-width: 220px;
            box-shadow: var(--shadow-lg);
            border-radius: 8px;
            z-index: 100;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .download-dropdown:hover .dropdown-content {
            display: block;
        }
        .download-dropdown .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .download-dropdown .dropdown-content a:hover {
            background-color: var(--background-color);
        }
        .download-dropdown .dropdown-content a i {
            width: 20px;
            text-align: center;
            color: var(--secondary-color);
        }
        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        .table-container { flex-grow: 1; overflow-y: auto; }
        #records-table { width: 100%; border-collapse: collapse; }
        #records-table th, #records-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #records-table thead th { 
            background-color: var(--background-color); 
            font-weight: 500; 
            color: var(--text-secondary); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        #records-table tbody tr { transition: background-color 0.2s; }
        #records-table tbody tr:hover { background-color: #F9F9F9; }
        .action-cell { display: flex; gap: 10px; }
        .action-cell button { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-secondary); transition: color 0.2s; }
        .action-cell button.delete-btn:hover { color: var(--error-color); }
        .pagination-container { 
            padding: 20px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-top: 1px solid var(--border-color); 
        }
        .pagination-info { color: var(--text-secondary); font-size: 14px; }
        .pagination { display: flex; gap: 5px; }
        .pagination button { 
            padding: 8px 12px; 
            border: 1px solid var(--border-color); 
            background-color: var(--surface-color); 
            color: var(--text-primary); 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .pagination button.active { 
            background-color: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .pagination button:hover:not(.active):not(:disabled) { 
            background-color: var(--background-color); 
        }
        .pagination button:disabled { 
            cursor: not-allowed; 
            opacity: 0.5; 
        }
        #status-message { 
            text-align: center; 
            padding: 40px; 
            font-size: 18px; 
            color: var(--text-secondary); 
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. AUTHENTICATION VIEW -->
        <div id="auth-container">
            <h2><i class="fas fa-lock"></i> Admin Login</h2>
            <p>Please sign in to access the dashboard.</p>
            <form id="auth-form">
                <input type="email" id="email-input" placeholder="Email Address" required>
                <input type="password" id="password-input" placeholder="Password" required>
                <button type="submit" id="login-btn">Sign In</button>
            </form>
            <p id="auth-error"></p>
            <p id="auth-success"></p>
            <div class="auth-link">
                Don't have an account? <a href="#" id="show-signup-link">Sign Up</a>
            </div>
        </div>

        <!-- 2. DATA VIEW (HIDDEN BY DEFAULT) -->
        <div id="data-panel">
            <div class="header">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <div class="user-info" id="user-email">user@example.com</div>
            </div>
            <div class="controls">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search records...">
                </div>
                <div class="action-buttons">
                    <button id="delete-selected-btn" style="background-color: #D32F2F; color: white; display:none;">
                        <i class="fas fa-trash-alt"></i> Delete Selected
                    </button>
                    <div class="download-dropdown">
                        <button id="download-selected-btn" disabled>
                            <i class="fas fa-download"></i> Download Selected <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" data-type="csv" data-scope="selected">
                                <i class="fas fa-file-csv"></i> CSV (Selected)
                            </a>
                            <a href="#" data-type="excel" data-scope="selected">
                                <i class="fas fa-file-excel"></i> Excel (Selected)
                            </a>
                            <a href="#" data-type="pdf" data-scope="selected">
                                <i class="fas fa-file-pdf"></i> PDF (Selected)
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" data-type="csv" data-scope="all">
                                <i class="fas fa-file-csv"></i> CSV (All Data)
                            </a>
                            <a href="#" data-type="excel" data-scope="all">
                                <i class="fas fa-file-excel"></i> Excel (All Data)
                            </a>
                            <a href="#" data-type="pdf" data-scope="all">
                                <i class="fas fa-file-pdf"></i> PDF (All Data)
                            </a>
                        </div>
                    </div>
                    <button id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox"></th>
                            <th>Date/Time</th>
                            <th>Time Start</th>
                            <th>Time End</th>
                            <th>Hours</th>
                            <th>Quantity</th>
                            <th>Vehicle</th>
                            <th>Driver</th>
                            <th>Address</th>
                            <th>Purchaser</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data will be injected here by JavaScript -->
                    </tbody>
                </table>
                <div id="status-message" style="display: none;">No records found.</div>
            </div>
            <div class="pagination-container">
                <div class="pagination-info" id="pagination-info">Showing 0 to 0 of 0 entries</div>
                <div class="pagination" id="pagination-controls">
                    <!-- Pagination buttons will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signup-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Create New Account</h2>
            <form id="signup-form">
                <input type="email" id="signup-email" placeholder="New Email Address" required>
                <input type="password" id="signup-password" placeholder="New Password" required>
                <button type="submit">Sign Up</button>
            </form>
            <p id="signup-error" style="color: var(--error-color); margin-top: 15px;"></p>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyANmru4_kH0eDNgDFURF5aZTaiPgaQ4avU",
            authDomain: "vipteammod-movies.firebaseapp.com",
            projectId: "vipteammod-movies",
            storageBucket: "vipteammod-movies.appspot.com",
            messagingSenderId: "1024721077525",
            appId: "1:1024721077525:android:c25e4ab10ec8e4166ad51c",
            databaseURL: "https://vipteammod-movies-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // --- 2. CONFIG ---
        const RECORDS_PER_PAGE = 25;
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;

        // --- 3. DOM ELEMENT REFERENCES ---
        const authContainer = document.getElementById('auth-container');
        const dataPanel = document.getElementById('data-panel');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authSuccess = document.getElementById('auth-success');
        const userEmailSpan = document.getElementById('user-email');
        const searchInput = document.getElementById('search-input');
        const logoutBtn = document.getElementById('logout-btn');
        const downloadSelectedBtn = document.getElementById('download-selected-btn');
        const tableBody = document.getElementById('table-body');
        const statusMessage = document.getElementById('status-message');
        const paginationControls = document.getElementById('pagination-controls');
        const paginationInfo = document.getElementById('pagination-info');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');

        // Modal elements
        const signupModal = document.getElementById('signup-modal');
        const showSignupLink = document.getElementById('show-signup-link');
        const signupForm = document.getElementById('signup-form');
        const signupError = document.getElementById('signup-error');
        const modalCloseBtn = document.getElementsByClassName("close")[0];

        // --- 4. AUTHENTICATION LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('User logged in:', user.email);
                userEmailSpan.textContent = user.email;
                authContainer.style.display = 'none';
                dataPanel.style.display = 'flex';
                fetchData();
            } else {
                console.log('User logged out.');
                authContainer.style.display = 'flex';
                dataPanel.style.display = 'none';
            }
        });

        // Login Form Handler
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            authError.textContent = '';
            authSuccess.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    authSuccess.textContent = 'Login successful!';
                })
                .catch(error => {
                    console.error("Login failed:", error);
                    authError.textContent = `Error: ${error.message}`;
                });
        });

        // Logout Button Handler
        logoutBtn.addEventListener('click', () => auth.signOut());

        // Modal Controls
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.style.display = 'flex';
        });
        modalCloseBtn.onclick = () => {
            signupModal.style.display = 'none';
        };
        window.onclick = (event) => {
            if (event.target == signupModal) {
                signupModal.style.display = 'none';
            }
        };

        // Sign Up Form Handler
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            signupError.textContent = '';

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    signupModal.style.display = 'none';
                    authSuccess.textContent = 'Account created successfully! You can now log in.';
                    authForm.reset();
                })
                .catch(error => {
                    console.error("Sign up failed:", error);
                    signupError.textContent = `Error: ${error.message}`;
                });
        });
        
        // --- 5. DATA FETCHING AND DISPLAY LOGIC ---
        function fetchData() {
            statusMessage.style.display = 'block';
            statusMessage.textContent = 'Loading data...';
            db.ref('pdfFormData').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    allRecords = [];
                    snapshot.forEach(childSnapshot => {
                        const record = childSnapshot.val();
                        record.id = childSnapshot.key;
                        allRecords.push(record);
                    });
                    allRecords.reverse();
                    filteredRecords = [...allRecords];
                    currentPage = 1;
                    updateDisplay();
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    statusMessage.textContent = 'Error loading data.';
                });
        }

        function updateDisplay() {
            renderTable();
            renderPagination();
            updateDownloadButtonState();
        }

        function renderTable() {
            tableBody.innerHTML = '';
            const start = (currentPage - 1) * RECORDS_PER_PAGE;
            const end = start + RECORDS_PER_PAGE;
            const paginatedRecords = filteredRecords.slice(start, end);

            if (paginatedRecords.length === 0) {
                statusMessage.style.display = 'block';
                statusMessage.textContent = 'No records found.';
                paginationControls.innerHTML = '';
                paginationInfo.textContent = 'Showing 0 to 0 of 0 entries';
                return;
            }
            
            statusMessage.style.display = 'none';

            paginatedRecords.forEach(record => {
                const row = document.createElement('tr');
                const formatTimestamp = (ts) => ts ? new Date(ts).toLocaleString() : 'N/A';
                
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-id="${record.id}"></td>
                    <td>${formatTimestamp(record.timestamp)}</td>
                    <td>${record.timestart || 'N/A'}</td>
                    <td>${record.timeend || 'N/A'}</td>
                    <td>${record.hours || 'N/A'}</td>
                    <td>${record.quantity || 'N/A'}</td>
                    <td>${record.vehicle || 'N/A'}</td>
                    <td>${record.driver || 'N/A'}</td>
                    <td>${record.address || 'N/A'}</td>
                    <td>${record.purchaser || 'N/A'}</td>
                    <td class="action-cell">
                        <button class="delete-btn" data-id="${record.id}" title="Delete Record">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            attachActionListeners();
        }
        
        function attachActionListeners() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.addEventListener('change', handleRowSelection);
            });
        }
        
        function handleDelete(e) {
            const recordId = e.currentTarget.closest('button').dataset.id;
            const isConfirmed = confirm("Are you sure you want to delete this record? This action cannot be undone.");
            if (isConfirmed) {
                db.ref('pdfFormData').child(recordId).remove()
                    .then(() => {
                        showNotification('Record deleted successfully.', 'success');
                        fetchData();
                    })
                    .catch(error => {
                        console.error("Error deleting record:", error);
                        showNotification('Failed to delete record.', 'error');
                    });
            }
        }

        function renderPagination() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(filteredRecords.length / RECORDS_PER_PAGE);
            if (totalPages <= 1) {
                paginationInfo.textContent = `Showing ${filteredRecords.length} of ${filteredRecords.length} entries`;
                return;
            }

            const start = (currentPage - 1) * RECORDS_PER_PAGE + 1;
            const end = Math.min(currentPage * RECORDS_PER_PAGE, filteredRecords.length);
            paginationInfo.textContent = `Showing ${start} to ${end} of ${filteredRecords.length} entries`;

            const prevBtn = createPaginationButton('Previous', currentPage > 1, () => { 
                currentPage--; 
                updateDisplay(); 
            });
            paginationControls.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageBtn = createPaginationButton(i, true, () => { 
                        currentPage = i; 
                        updateDisplay(); 
                    }, i === currentPage);
                    paginationControls.appendChild(pageBtn);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 10px';
                    paginationControls.appendChild(dots);
                }
            }

            const nextBtn = createPaginationButton('Next', currentPage < totalPages, () => { 
                currentPage++; 
                updateDisplay(); 
            });
            paginationControls.appendChild(nextBtn);
        }

        function createPaginationButton(text, isEnabled, onClick, isActive = false) {
            const button = document.createElement('button');
            button.textContent = text;
            button.disabled = !isEnabled;
            button.onclick = onClick;
            if (isActive) button.classList.add('active');
            return button;
        }

        // --- 6. SEARCH FUNCTIONALITY ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm === '') {
                filteredRecords = [...allRecords];
            } else {
                filteredRecords = allRecords.filter(record => {
                    return Object.values(record).some(val =>
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
            }
            currentPage = 1;
            updateDisplay();
        });

        // --- 7. SELECTION LOGIC ---
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
            updateDownloadButtonState();
            updateDeleteSelectedState();
        });

        function handleRowSelection() {
            updateDownloadButtonState();
            updateDeleteSelectedState();
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
        }
        
        function updateDownloadButtonState() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            downloadSelectedBtn.disabled = checkedBoxes.length === 0;
            
            if(checkedBoxes.length > 0) {
                deleteSelectedBtn.style.display = 'inline-flex';
            } else {
                deleteSelectedBtn.style.display = 'none';
            }
        }

        function updateDeleteSelectedState() {
            // Kept for potential future state logic if needed
        }

        // --- 8. DELETE SELECTED RECORDS ---
        deleteSelectedBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} record(s)?`)) {
                Promise.all(selectedIds.map(id => db.ref('pdfFormData').child(id).remove()))
                    .then(() => {
                        showNotification(`Deleted ${selectedIds.length} record(s) successfully.`, 'success');
                        fetchData(); 
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification('Error deleting one or more records.', 'error');
                    });
            }
        });

        // --- 9. DOWNLOAD FUNCTIONALITY ---
        document.querySelectorAll('.dropdown-content a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const type = e.target.closest('a').dataset.type;
                const scope = e.target.closest('a').dataset.scope;
                
                let recordsToDownload;
                if (scope === 'selected') {
                    const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.dataset.id);
                    recordsToDownload = allRecords.filter(r => selectedIds.includes(r.id));
                    
                    if (recordsToDownload.length === 0) {
                        alert('Please select at least one record to download.');
                        return;
                    }
                } else {
                    recordsToDownload = filteredRecords;
                }
                
                if (recordsToDownload.length > 0) {
                    switch(type) {
                        case 'csv':
                            downloadCSV(recordsToDownload, scope);
                            break;
                        case 'excel':
                            downloadExcel(recordsToDownload, scope);
                            break;
                        case 'pdf':
                            downloadPDF(recordsToDownload, scope);
                            break;
                    }
                }
            });
        });

        // --- 10. DOWNLOAD FUNCTIONS ---

        // CSV Download Function
        function downloadCSV(records, scope) {
            if (records.length === 0) return;
            
            const headers = ['Date/Time', 'Time Start', 'Time End', 'Hours', 'Quantity', 'Vehicle', 'Driver', 'Address', 'Purchaser'];
            const csvContent = [
                headers.join(','),
                ...records.map(record => {
                    const formatTimestamp = (ts) => ts ? new Date(ts).toLocaleString() : 'N/A';
                    return [
                        formatTimestamp(record.timestamp), 
                        record.timestart || 'N/A', 
                        record.timeend || 'N/A',
                        record.hours || 'N/A', 
                        record.quantity || 'N/A', 
                        record.vehicle || 'N/A',
                        record.driver || 'N/A', 
                        record.address || 'N/A', 
                        record.purchaser || 'N/A'
                    ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_${scope}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Excel Download Function
        function downloadExcel(records, scope) {
            if (records.length === 0) return;
            
            const headers = ['Date/Time', 'Time Start', 'Time End', 'Hours', 'Quantity', 'Vehicle', 'Driver', 'Address', 'Purchaser'];
            const data = [
                headers,
                ...records.map(record => {
                    const formatTimestamp = (ts) => ts ? new Date(ts).toLocaleString() : 'N/A';
                    return [
                        formatTimestamp(record.timestamp), 
                        record.timestart || 'N/A', 
                        record.timeend || 'N/A',
                        record.hours || 'N/A', 
                        record.quantity || 'N/A', 
                        record.vehicle || 'N/A',
                        record.driver || 'N/A', 
                        record.address || 'N/A', 
                        record.purchaser || 'N/A'
                    ];
                })
            ];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            const wscols = [
                {wch: 20}, // Date/Time
                {wch: 12}, // Time Start
                {wch: 12}, // Time End
                {wch: 8},  // Hours
                {wch: 10}, // Quantity
                {wch: 15}, // Vehicle
                {wch: 15}, // Driver
                {wch: 25}, // Address
                {wch: 20}  // Purchaser
            ];
            ws['!cols'] = wscols;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Records');
            
            // Generate and download file
            XLSX.writeFile(wb, `data_${scope}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        // PDF Download Function
        function downloadPDF(records, scope) {
            if (records.length === 0) return;
            
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            // Title
            const title = `Data Export - ${scope === 'selected' ? 'Selected Records' : 'All Records'}`;
            const date = new Date().toLocaleDateString();
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated on: ${date} | Total Records: ${records.length}`, 14, 22);
            
            // Prepare table data
            const tableColumn = ['No.', 'Date/Time', 'Time Start', 'Time End', 'Hours', 'Quantity', 'Vehicle', 'Driver', 'Address', 'Purchaser'];
            const tableRows = [];
            
            records.forEach((record, index) => {
                const formatTimestamp = (ts) => ts ? new Date(ts).toLocaleString() : 'N/A';
                const recordData = [
                    (index + 1).toString(),
                    formatTimestamp(record.timestamp),
                    record.timestart || 'N/A',
                    record.timeend || 'N/A',
                    record.hours || 'N/A',
                    record.quantity || 'N/A',
                    record.vehicle || 'N/A',
                    record.driver || 'N/A',
                    record.address || 'N/A',
                    record.purchaser || 'N/A'
                ];
                tableRows.push(recordData);
            });
            
            try {
                // Generate autoTable
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'grid',
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [13, 71, 161], // Primary color
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 10 }, // No.
                        1: { cellWidth: 25 }, // Date/Time
                        2: { cellWidth: 15 }, // Time Start
                        3: { cellWidth: 15 }, // Time End
                        4: { cellWidth: 12 }, // Hours
                        5: { cellWidth: 12 }, // Quantity
                        6: { cellWidth: 18 }, // Vehicle
                        7: { cellWidth: 18 }, // Driver
                        8: { cellWidth: 30 }, // Address
                        9: { cellWidth: 25 }  // Purchaser
                    },
                    margin: { top: 30 }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        doc.internal.pageSize.width - 25,
                        doc.internal.pageSize.height - 10
                    );
                }
                
                // Save PDF
                doc.save(`data_${scope}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                showNotification('Error generating PDF. Please try again.', 'error');
                
                // Fallback: Create a simple text PDF if autoTable fails
                const fallbackDoc = new jsPDF();
                fallbackDoc.text("PDF Export", 20, 20);
                fallbackDoc.text(`Total records: ${records.length}`, 20, 30);
                fallbackDoc.text("Detailed table could not be generated.", 20, 40);
                fallbackDoc.save(`data_${scope}_simple_${new Date().toISOString().slice(0, 10)}.pdf`);
            }
        }

        // --- 11. NOTIFICATION FUNCTION ---
        function showNotification(message, type) {
            console.log(`Notification (${type}): ${message}`);
            alert(message);
        }
    </script>
</body>
</html>