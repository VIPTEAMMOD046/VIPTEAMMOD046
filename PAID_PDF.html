<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Form Editor</title>

    <!-- QR Code Library -->
    <script src="Pdf/qrcode.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
      <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* ===== RESET & VARIABLES ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #3b82f6;
    --primary-soft: #dbeafe;
    --success: #059669;
    --success-light: #d1fae5;
    --warning: #d97706;
    --warning-light: #fef3c7;
    --danger: #dc2626;
    --danger-light: #fee2e2;
    --dark: #0f172a;
    --dark-light: #334155;
    --gray: #64748b;
    --gray-light: #94a3b8;
    --gray-soft: #e2e8f0;
    --gray-bg: #f8fafc;
    --white: #ffffff;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.02);
    --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.01);
    --shadow-xl: 0 25px 50px -12px rgba(0,0,0,0.15);
    --radius-sm: 6px;
    --radius: 10px;
    --radius-md: 14px;
    --radius-lg: 20px;
    --radius-xl: 30px;
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
}

body {
    font-family: var(--font-sans);
    background: linear-gradient(145deg, #f1f5f9 0%, #e6edf5 100%);
    min-height: 100vh;
    color: var(--dark);
    line-height: 1.5;
    overflow-x: hidden;
}

/* ===== APP CONTAINER ===== */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* ===== HEADER ===== */
header {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.6);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 0;
    z-index: 100;
}

.title {
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(135deg, var(--dark), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.title i {
    font-size: 1.8rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

/* ===== BUTTONS ===== */
.save-btn {
    padding: 0.7rem 1.2rem;
    color: white;
    border: none;
    border-radius: var(--radius-xl);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: 0.25px;
    font-family: var(--font-sans);
}

.save-btn#save-btn {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    box-shadow: 0 10px 20px -8px var(--primary);
}

.save-btn#save-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 30px -10px var(--primary);
}

.save-btn#FScreen-btn {
    background: linear-gradient(135deg, var(--dark), var(--dark-light));
    box-shadow: 0 10px 20px -8px var(--dark);
}

.save-btn#FScreen-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 30px -10px var(--dark);
}

.save-btn#open-pdf-btn {
    background: linear-gradient(135deg, var(--warning), #e67e22);
    box-shadow: 0 10px 20px -8px var(--warning);
}

.save-btn#open-pdf-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 30px -10px var(--warning);
}

.save-btn#login-status-btn {
    background: linear-gradient(135deg, var(--success), #047857);
    box-shadow: 0 10px 20px -8px var(--success);
}

.save-btn#login-status-btn:hover {
    transform: translateY(-3px);
}

.save-btn#admin-panel-btn {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    box-shadow: 0 10px 20px -8px #8b5cf6;
}

.save-btn#buy-edits-btn {
    background: linear-gradient(135deg, var(--warning), #e67e22);
    box-shadow: 0 10px 20px -8px var(--warning);
}

/* ===== QUALITY SELECTION ===== */
.quality-selection {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 1rem 1.5rem;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    margin: 1.5rem 2rem;
}

.quality-selection label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--dark-light);
    white-space: nowrap;
}

.quality-select {
    padding: 0.6rem 2.5rem 0.6rem 1rem;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius);
    background-color: white;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    color: var(--dark);
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    transition: all 0.2s;
}

.quality-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-soft);
}

/* ===== TOOLBAR ===== */
.toolbar {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-lg);
    margin: 0 2rem 1.5rem;
    border-radius: var(--radius-xl);
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toolbar-label {
    font-size: 0.85rem;
    color: var(--gray);
    font-weight: 600;
}

.page-nav, .zoom-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-btn, .zoom-btn {
    width: 38px;
    height: 38px;
    border: none;
    background: white;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
    color: var(--dark);
    box-shadow: var(--shadow-sm);
}

.page-btn:hover:not(:disabled), .zoom-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -8px var(--primary);
}

.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info, .zoom-level {
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 80px;
    text-align: center;
    color: var(--dark);
}

/* ===== PDF CONTAINER ===== */
.pdf-container {
    flex: 1;
    overflow: auto;
    background: linear-gradient(145deg, #f1f5f9 0%, #e6edf5 100%);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    position: relative;
}

.pdf-page {
    position: relative;
    box-shadow: var(--shadow-xl);
    background-color: white;
    margin: 20px;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.canvas-wrapper {
    position: relative;
    display: inline-block;
}

#pdf-canvas, #edit-canvas {
    display: block;
}

#edit-canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
}

/* ===== TEXT BOX ===== */
.text-box {
    position: absolute;
    border: 2px dashed transparent;
    cursor: pointer;
    z-index: 20;
    transition: all 0.2s;
    border-radius: var(--radius-sm);
}

.text-box:hover {
    background-color: rgba(37, 99, 235, 0.1);
    border-color: var(--primary);
}

.text-box.edited {
    border-color: var(--success);
    background-color: rgba(5, 150, 105, 0.1);
}

/* ===== IMAGE BOX ===== */
.image-box {
    position: absolute;
    border: 2px dashed var(--primary);
    cursor: pointer;
    z-index: 20;
    transition: all 0.2s;
    border-radius: var(--radius-sm);
}

.image-box:hover {
    border-color: var(--primary-dark);
    background-color: rgba(37, 99, 235, 0.1);
}

/* ===== EDIT DIALOG ===== */
.text-input {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 0;
    border: none;
    background-color: white;
    font-family: var(--font-sans);
    z-index: 10000;
    outline: none;
    box-shadow: var(--shadow-xl);
    border-radius: var(--radius-xl);
    min-width: 550px;
    max-width: 95%;
    overflow: hidden;
}

.dialog-header {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-weight: 600;
    cursor: move;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dialog-header span {
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
    font-size: 1.2rem;
}

.dialog-header span:hover {
    opacity: 1;
}

.edit-controls {
    display: flex;
    gap: 15px;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-soft);
    flex-wrap: wrap;
    align-items: center;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-label {
    font-size: 0.85rem;
    color: var(--gray);
    font-weight: 600;
    min-width: 50px;
}

.color-input {
    width: 36px;
    height: 36px;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius-sm);
    cursor: pointer;
    padding: 0;
}

.font-select {
    padding: 0.5rem 2rem 0.5rem 0.8rem;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius-sm);
    background-color: white;
    font-family: var(--font-sans);
    cursor: pointer;
    font-size: 0.85rem;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 12px;
}

.size-input {
    width: 60px;
    padding: 0.5rem;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius-sm);
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    font-family: var(--font-sans);
}

.slider-input {
    width: 100px;
    cursor: pointer;
    accent-color: var(--primary);
}

.slider-value {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary);
    min-width: 30px;
    text-align: center;
}

.font-btn, .bold-btn, .color-btn, .toggler-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--gray-soft);
    background: white;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    color: var(--dark);
    font-weight: 600;
    font-family: var(--font-sans);
}

.font-btn:hover, .bold-btn:hover, .color-btn:hover, .toggler-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.font-btn.active, .bold-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.toggler-btn.active {
    background: var(--primary-light);
    color: white;
    border-color: var(--primary-light);
}

#dialog-input {
    width: calc(100% - 3rem);
    margin: 1rem 1.5rem;
    padding: 1rem;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius);
    font-size: 1rem;
    font-family: var(--font-sans);
    transition: all 0.2s;
}

#dialog-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-soft);
}

.dialog-buttons {
    display: flex;
    gap: 10px;
    padding: 0 1.5rem 1.5rem;
    justify-content: flex-end;
}

.dialog-btn {
    padding: 0.7rem 1.5rem;
    border: none;
    border-radius: var(--radius-xl);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s;
    font-family: var(--font-sans);
}

.dialog-btn-save {
    background: linear-gradient(135deg, var(--success), #047857);
    color: white;
    box-shadow: 0 10px 20px -8px var(--success);
}

.dialog-btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px -10px var(--success);
}

.dialog-btn-cancel {
    background: var(--gray-soft);
    color: var(--dark);
}

.dialog-btn-cancel:hover {
    background: var(--gray);
    color: white;
}

/* ===== NOTIFICATION ===== */
.notification {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: white;
    color: var(--dark);
    padding: 1rem 1.5rem;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s;
    font-size: 0.95rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-left: 5px solid var(--success);
}

.notification.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.notification.error { border-left-color: var(--danger); }
.notification.warning { border-left-color: var(--warning); }

#notification-cancel {
    background: none;
    border: none;
    color: var(--gray);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

#notification-cancel:hover {
    color: var(--dark);
}

/* ===== LOADING OVERLAY ===== */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.loading-overlay.show {
    opacity: 1;
    pointer-events: all;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid var(--gray-soft);
    border-top: 5px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== LOGIN MODAL ===== */
#login-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

#login-modal > div {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    padding: 2.5rem;
    border-radius: 40px;
    width: 90%;
    max-width: 450px;
    box-shadow: var(--shadow-xl);
    position: relative;
}

#login-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

#login-header h2 {
    color: var(--dark);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 1.5rem;
    font-weight: 700;
}

#login-header p {
    color: var(--gray);
    margin-top: 0.5rem;
    font-size: 0.95rem;
}

#login-email, #login-password {
    width: 100%;
    padding: 1rem 1.2rem;
    margin-bottom: 1rem;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius-lg);
    font-size: 1rem;
    font-family: var(--font-sans);
    transition: all 0.2s;
}

#login-email:focus, #login-password:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-soft);
}

#login-button, #logout-button, #logout-button-inside {
    width: 100%;
    padding: 1rem;
    border: none;
    border-radius: var(--radius-lg);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 0.5rem;
    font-family: var(--font-sans);
    transition: all 0.3s;
}

#login-button {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 10px 20px -8px var(--primary);
}

#login-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 30px -10px var(--primary);
}

#logout-button, #logout-button-inside {
    background: linear-gradient(135deg, var(--danger), #b91c1c);
    color: white;
    box-shadow: 0 10px 20px -8px var(--danger);
}

#close-login {
    position: absolute;
    top: 15px;
    right: 20px;
    background: white;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: all 0.2s;
}

#close-login:hover {
    background: var(--danger);
    color: white;
    transform: rotate(90deg);
}

/* ===== USER DASHBOARD ===== */
#user-dashboard {
    text-align: center;
}

.dashboard-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 50%;
    margin: 0 auto 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: 700;
    box-shadow: 0 10px 30px -10px var(--primary);
}

#user-email {
    font-weight: 700;
    color: var(--dark);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

#user-plan {
    display: inline-block;
    background: var(--primary-soft);
    color: var(--primary);
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.dashboard-stats {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    color: white;
}

.dashboard-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-weight: 600;
}

#dashboard-plan-badge {
    background: rgba(255,255,255,0.2);
    padding: 0.2rem 0.8rem;
    border-radius: 30px;
    font-size: 0.75rem;
}

.progress-container {
    margin-bottom: 1rem;
}

.progress-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: rgba(255,255,255,0.3);
    border-radius: 10px;
    overflow: hidden;
}

#dashboard-progress {
    height: 100%;
    background: #fbbf24;
    transition: width 0.3s;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.stat-item {
    background: rgba(255,255,255,0.1);
    padding: 1rem;
    border-radius: var(--radius);
    text-align: center;
}

.stat-item .value {
    font-size: 1.5rem;
    font-weight: 700;
}

.stat-item .label {
    font-size: 0.8rem;
    opacity: 0.9;
}

.dashboard-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 1rem;
}

#dashboard-buy-btn {
    flex: 1;
    padding: 1rem;
    background: linear-gradient(135deg, var(--warning), #e67e22);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 10px 20px -8px var(--warning);
    transition: all 0.3s;
}

#dashboard-buy-btn:hover {
    transform: translateY(-2px);
}

#dashboard-refresh-btn {
    width: 50px;
    background: white;
    border: none;
    border-radius: var(--radius-lg);
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: all 0.2s;
}

#dashboard-refresh-btn:hover {
    transform: rotate(180deg);
}

.quick-stats {
    display: flex;
    gap: 10px;
    margin-bottom: 1.5rem;
}

.quick-stat {
    flex: 1;
    background: var(--gray-bg);
    padding: 0.8rem;
    border-radius: var(--radius);
    text-align: center;
}

.quick-stat .value {
    font-weight: 700;
    color: var(--dark);
    font-size: 1.2rem;
}

.quick-stat .label {
    font-size: 0.8rem;
    color: var(--gray);
}

/* ===== PROFESSIONAL DIALOG ===== */
.professional-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100000;
    animation: fadeIn 0.3s ease;
}

.professional-dialog .dialog-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 30px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    position: relative;
    box-shadow: var(--shadow-xl);
    animation: slideIn 0.3s ease;
}

.professional-dialog .dialog-icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 1rem;
}

.professional-dialog .dialog-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.5rem;
    text-align: center;
}

.professional-dialog .dialog-message {
    font-size: 1rem;
    color: var(--gray);
    margin-bottom: 1.5rem;
    text-align: center;
    line-height: 1.6;
    white-space: pre-line;
}

.professional-dialog .dialog-progress {
    margin-bottom: 1.5rem;
}

.professional-dialog .progress-bar {
    width: 100%;
    height: 10px;
    background: var(--gray-soft);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.professional-dialog .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    transition: width 0.3s ease;
}

.professional-dialog .progress-text {
    text-align: center;
    font-size: 0.85rem;
    color: var(--gray);
}

.professional-dialog .dialog-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.professional-dialog .dialog-btn-ok {
    padding: 0.8rem 2rem;
    background: linear-gradient(135deg, var(--gray), var(--dark-light));
    color: white;
    border: none;
    border-radius: var(--radius-xl);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    flex: 1;
}

.professional-dialog .dialog-btn-ok:hover {
    transform: translateY(-2px);
}

.professional-dialog .dialog-btn-buy {
    padding: 0.8rem 2rem;
    background: linear-gradient(135deg, var(--warning), #e67e22);
    color: white;
    border: none;
    border-radius: var(--radius-xl);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    flex: 1;
    box-shadow: 0 10px 20px -8px var(--warning);
}

.professional-dialog .dialog-btn-buy:hover {
    transform: translateY(-2px);
}

.professional-dialog .dialog-close {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 35px;
    height: 35px;
    background: var(--gray-bg);
    border: none;
    border-radius: 50%;
    font-size: 1rem;
    color: var(--gray);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.professional-dialog .dialog-close:hover {
    background: var(--danger);
    color: white;
    transform: rotate(90deg);
}

/* ===== PAYMENT DIALOG ===== */
.payment-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200000;
    animation: fadeIn 0.3s ease;
}

.payment-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 30px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: var(--shadow-xl);
}

.payment-header {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border-radius: 30px 30px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.payment-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.payment-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.payment-close:hover {
    background: rgba(255,255,255,0.2);
    transform: rotate(90deg);
}

.payment-plans {
    padding: 1.5rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
}

.plan-card {
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius-lg);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.plan-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.plan-card.selected {
    border-color: var(--warning);
    background: var(--warning-light);
    transform: scale(1.05);
}

.plan-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.3rem;
}

.plan-edits {
    font-size: 1.1rem;
    color: var(--success);
    font-weight: 600;
    margin-bottom: 0.3rem;
}

.plan-name {
    font-size: 0.75rem;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.popular-tag {
    background: var(--warning);
    color: white;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    display: inline-block;
    margin-top: 0.3rem;
}

.payment-upi, .payment-screenshot {
    padding: 0 1.5rem 1.5rem;
}

.payment-upi h3, .payment-screenshot h3 {
    margin-bottom: 1rem;
    color: var(--dark);
    font-size: 1.1rem;
}

.upi-options {
    display: flex;
    gap: 12px;
    margin-bottom: 1rem;
}

.upi-option {
    flex: 1;
    border: 2px solid var(--gray-soft);
    border-radius: var(--radius);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.upi-option:hover {
    border-color: var(--primary);
}

.upi-option.selected {
    border-color: var(--warning);
    background: var(--warning-light);
}

.selected-upi {
    background: var(--gray-bg);
    padding: 1rem;
    border-radius: var(--radius);
    text-align: center;
    border: 2px dashed var(--gray-soft);
    font-size: 1rem;
}

.screenshot-preview {
    width: 100%;
    min-height: 150px;
    border: 2px dashed var(--gray-soft);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gray-bg);
    overflow: hidden;
}

.screenshot-preview img {
    max-width: 100%;
    max-height: 200px;
    object-fit: contain;
}

.screenshot-info {
    font-size: 0.8rem;
    color: var(--gray);
    text-align: center;
    margin-top: 0.5rem;
}

.payment-actions {
    padding: 1.5rem;
    border-top: 1px solid var(--gray-soft);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.payment-btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: var(--radius-xl);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: var(--font-sans);
}

.payment-submit {
    background: linear-gradient(135deg, var(--success), #047857);
    color: white;
    box-shadow: 0 10px 20px -8px var(--success);
}

.payment-submit:hover {
    transform: translateY(-2px);
}

.payment-back {
    background: linear-gradient(135deg, var(--gray), var(--dark-light));
    color: white;
}

#upload-screenshot-btn {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, var(--dark), var(--dark-light));
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

#upload-screenshot-btn:hover {
    transform: translateY(-2px);
}

/* ===== ADMIN PANEL ===== */
.admin-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 300000;
    animation: fadeIn 0.3s ease;
}

.admin-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 30px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
}

.admin-header {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, var(--dark), var(--dark-light));
    color: white;
    border-radius: 30px 30px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-header h2 {
    margin: 0;
    font-size: 1.3rem;
}

.admin-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.admin-close:hover {
    background: rgba(255,255,255,0.2);
}

.admin-stats {
    padding: 1.5rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    background: var(--gray-bg);
}

.admin-stat-card {
    background: white;
    padding: 1rem;
    border-radius: var(--radius-lg);
    text-align: center;
    box-shadow: var(--shadow-sm);
}

.admin-stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark);
}

.admin-stat-label {
    font-size: 0.85rem;
    color: var(--gray);
}

.admin-payments {
    padding: 1.5rem;
}

.payment-item {
    border: 1px solid var(--gray-soft);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
}

.payment-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.payment-user {
    font-weight: 600;
    color: var(--dark);
}

.payment-status {
    padding: 0.3rem 0.8rem;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: var(--warning-light); color: var(--warning); }
.status-approved { background: var(--success-light); color: var(--success); }
.status-rejected { background: var(--danger-light); color: var(--danger); }

.payment-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 0.8rem;
    font-size: 0.85rem;
    color: var(--gray);
}

.payment-screenshot {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: var(--radius);
    margin: 0.8rem 0;
    cursor: pointer;
}

.payment-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.action-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.approve-btn {
    background: linear-gradient(135deg, var(--success), #047857);
    color: white;
}

.approve-btn:hover {
    transform: translateY(-2px);
}

.reject-btn {
    background: linear-gradient(135deg, var(--danger), #b91c1c);
    color: white;
}

.reject-btn:hover {
    transform: translateY(-2px);
}

.no-payments {
    text-align: center;
    padding: 3rem;
    color: var(--gray);
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes iconPop {
    0% { transform: scale(0); }
    70% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    header {
        padding: 1rem;
        flex-wrap: wrap;
        flex-direction: column;
        gap: 1rem;
    }
    
    .title {
        font-size: 1.2rem;
    }
    
    .header-controls {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .save-btn {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
    }
    
    .quality-selection {
        margin: 1rem;
        padding: 1rem;
        flex-wrap: wrap;
    }
    
    .toolbar {
        margin: 0 1rem 1rem;
        padding: 1rem;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .pdf-container {
        padding: 10px;
    }
    
    .pdf-page {
        margin: 10px;
    }
    
    .text-input {
        min-width: 300px;
    }
    
    .admin-stats {
        grid-template-columns: 1fr;
    }
    
    .payment-details {
        grid-template-columns: 1fr 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<!-- Login Modal -->
<div id="login-modal" style="display: none;">
    <div>
        <div id="login-header">
            <h2><i class="fas fa-lock"></i> <span id="login-title">Login Required</span></h2>
            <p id="login-subtitle">Please login to access PDF Form Editor</p>
        </div>
        
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email address">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-button"><i class="fas fa-sign-in-alt"></i> Login</button>
            <button id="logout-button" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        
        <div id="user-dashboard" style="display: none;">
            <div class="dashboard-avatar">
                <span id="user-avatar">U</span>
            </div>
            <p style="color: var(--success); font-weight: 600; margin-bottom: 0.3rem;"><i class="fas fa-check-circle"></i> Logged in as</p>
            <p id="user-email"></p>
            <p id="user-plan">Free Plan</p>
            
            <div class="dashboard-stats">
                <div class="dashboard-stats-header">
                    <span><i class="fas fa-chart-bar"></i> Your Usage</span>
                    <span id="dashboard-plan-badge">Free</span>
                </div>
                <div class="progress-container">
                    <div class="progress-labels">
                        <span>Used: <span id="dashboard-used">0</span> edits</span>
                        <span>Total: <span id="dashboard-total">2</span> edits</span>
                    </div>
                    <div class="progress-bar">
                        <div id="dashboard-progress" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value" id="dashboard-remaining">2</div>
                        <div class="label">Remaining</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="dashboard-used-count">0</div>
                        <div class="label">Used</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-actions">
                <button id="dashboard-buy-btn"><i class="fas fa-coins"></i> Buy More Edits</button>
                <button id="dashboard-refresh-btn"><i class="fas fa-sync-alt"></i></button>
            </div>
            
            <div class="quick-stats">
                <div class="quick-stat">
                    <div class="value" id="dashboard-pages">0</div>
                    <div class="label">Pages</div>
                </div>
                <div class="quick-stat">
                    <div class="value" id="dashboard-edits">0</div>
                    <div class="label">Edits Made</div>
                </div>
            </div>
            
            <button id="logout-button-inside"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        
        <button id="close-login">&times;</button>
    </div>
</div>

<!-- PDF Editor App -->
<div class="app-container" id="app-container">
    <header>
        <div class="title"><i class="fas fa-file-pdf"></i> PDF Form Editor</div>
        <div class="header-controls">
            <button class="save-btn" id="login-status-btn"><i class="fas fa-user"></i> Login</button>
            <button class="save-btn" id="open-pdf-btn"><i class="fas fa-folder-open"></i> Open PDF</button>
            <input type="file" id="pdf-file-input" accept="application/pdf" style="display: none;">
            <button class="save-btn" id="save-btn"><i class="fas fa-save"></i> Save PDF</button>
            <button class="save-btn" id="FScreen-btn"><i class="fas fa-expand"></i> Fullscreen</button>
        </div>
    </header>
    
    <div class="quality-selection">
        <label for="quality-select">Output Quality:</label>
        <select id="quality-select" class="quality-select">
            <option value="standard">Standard</option>
            <option value="high">High</option>
            <option value="ultra">Ultra</option>
            <option value="HD" selected>HD</option>
            <option value="pc">PC</option>
            <option value="ultraHD">Ultra HD</option>
        </select>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <div class="page-nav">
                <button class="page-btn" id="prev-page"><i class="fas fa-chevron-left"></i></button>
                <span class="page-info" id="page-info">Page 1 of 1</span>
                <button class="page-btn" id="next-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div class="toolbar-group">
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out"><i class="fas fa-minus"></i></button>
                <span class="zoom-level" id="zoom-level">216%</span>
                <button class="zoom-btn" id="zoom-in"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </div>
    
    <div class="pdf-container" id="pdf-container">
        <div class="pdf-page" id="pdf-page">
            <div class="canvas-wrapper" id="canvas-wrapper">
                <canvas id="pdf-canvas"></canvas>
                <canvas id="edit-canvas"></canvas>
            </div>
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <input type="file" id="image-input" accept="image/*" style="display: none;">

    <!-- Edit Dialog -->
    <div class="text-input" id="edit-dialog" style="display: none;">
        <div class="dialog-header">
            <span><i class="fas fa-edit"></i> Edit Text</span>
            <span id="dialog-minimize" title="Minimize">âˆ’</span>
        </div>
        <div class="edit-controls">
            <div class="control-group">
                <label class="control-label">Font:</label>
                <select class="font-select" id="font-select">
                    <option value="Roboto Thin">Roboto Thin</option>
                    <option value="Roboto Light">Roboto Light</option>
                    <option value="Roboto" selected>Roboto Regular</option>
                    <option value="Roboto Medium">Roboto Medium</option>
                    <option value="Roboto Bold">Roboto Bold</option>
                    <option value="Roboto Black">Roboto Black</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Size:</label>
                <input type="number" class="size-input" id="font-size-input" value="16" min="4" max="200">
            </div>

            <div class="control-group">
                <label class="control-label">Text:</label>
                <input type="color" class="color-input" id="text-color" value="#000000">
            </div>
            
            <div class="control-group">
                <label class="control-label">Bg:</label>
                <input type="color" class="color-input" id="bg-color" value="#ffffff">
                <button class="color-btn" id="pick-bg-btn"><i class="fas fa-eye-dropper"></i></button>
                <button class="toggler-btn" id="transparent-toggle">Trans</button>
            </div>
            
            <div class="control-group">
                <label class="control-label">Style:</label>
                <button class="font-btn" id="thin-btn">Thin</button>
                <button class="bold-btn" id="bold-btn">B</button>
            </div>
        </div>

        <div class="edit-controls" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
            <div class="control-group" style="width: 100%; margin-bottom: 8px;">
                <label class="control-label">Bold Thickness:</label>
                <input type="range" class="slider-input" id="bold-thickness-slider" min="0" max="10" value="1" step="0.5">
                <span class="slider-value" id="bold-thickness-value">1.0</span>
            </div>
            
            <div class="control-group" style="width: 100%; margin-bottom: 8px;">
                <label class="control-label">Adjust Y:</label>
                <input type="range" class="slider-input" id="y-adjust-slider" min="-50" max="50" value="0" step="1">
                <span class="slider-value" id="y-adjust-value">0</span>
            </div>
            
            <div class="control-group" style="width: 100%; margin-bottom: 8px;">
                <label class="control-label">Cover H:</label>
                <input type="range" class="slider-input" id="cover-height-slider" min="0" max="50" value="0" step="1">
                <span class="slider-value" id="cover-height-value">0</span>
            </div>

            <div class="control-group" style="width: 100%;">
                <label class="control-label">Cover Y:</label>
                <input type="range" class="slider-input" id="cover-y-slider" min="-50" max="50" value="0" step="1">
                <span class="slider-value" id="cover-y-value">0</span>
            </div>
        </div>

        <input type="text" id="dialog-input" placeholder="Enter new text...">
        
        <div class="dialog-buttons">
            <button class="dialog-btn dialog-btn-cancel" id="dialog-cancel">Cancel</button>
            <button class="dialog-btn dialog-btn-save" id="dialog-save"><i class="fas fa-check"></i> Save</button>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <span id="notification-message"></span>
        <button id="notification-cancel">&times;</button>
    </div>
</div>

<script>
// ==========================================
// FIREBASE INITIALIZATION
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyBsejOUBpCGAb44FJ1KkzaR05HBCK_oNbY",
    authDomain: "pdf-paid.firebaseapp.com",
    projectId: "pdf-paid",
    storageBucket: "pdf-paid.firebasestorage.app",
    messagingSenderId: "194238529471",
    appId: "1:194238529471:android:dad140450829341edd2b0a",
    databaseURL: "https://pdf-paid-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

// ==========================================
// PAYMENT PLANS
// ==========================================
const PAYMENT_PLANS = {
    plan10: { price: 10, edits: 20, name: 'Basic' },
    plan20: { price: 20, edits: 40, name: 'Popular' },
    plan30: { price: 30, edits: 60, name: 'Standard' },
    plan40: { price: 40, edits: 80, name: 'Pro' },
    plan50: { price: 50, edits: 100, name: 'Business' },
    plan100: { price: 100, edits: 200, name: 'Premium' },
    plan500: { price: 500, edits: 1000, name: 'Ultimate' }
};

const UPI_OPTIONS = {
    googlepay: { name: 'Google Pay', id: 'arunkumar6456435@okicici' },
    phonepe: { name: 'PhonePe', id: 'vipteammodvip@ybl' }
};

const ADMIN_EMAIL = 'arun@gmail.com';

// ==========================================
// GLOBAL VARIABLES
// ==========================================
let isOnline = navigator.onLine;
let connectionCheckInterval;
let pdfDoc = null;
let pageNum = 1;
let pageCount = 1;
let scale = 2.16;
let minZoom = 0.5;
let maxZoom = 5.0;
let allPageEdits = {};
let textItems = [];
let imageItems = [];
let textBoxes = [];
let imageBoxes = [];
let currentViewport = null;
let originalPageSize = { width: 0, height: 0 };
let currentEditingTextItem = null;
let currentEditingTextBox = null;
let currentEditingImageItem = null;
let currentBgColor = '#ffffff';
let currentTextColor = '#000000';
let currentFontSize = 16;
let currentTextBold = false;
let currentTextThin = false;
let currentFontFamily = 'Roboto';
let isBgTransparent = false;
let currentYAdjust = 0;
let currentCoverHeight = 0;
let currentCoverY = 0;
let currentBoldThickness = 1.0;
let originalTextStyles = {};
let formFields = {};
let editInProgress = false;

let watermarkSettings = {
    enabled: false,
    text: 'FREE VERSION - PDF EDITOR',
    fontSize: 72,
    opacity: 0.3,
    color: '#ff0000',
    angle: 45,
    position: 'diagonal',
    pattern: 'single',
    outline: true,
    outlineColor: '#ffffff'
};

// DOM Elements
const pdfCanvas = document.getElementById('pdf-canvas');
const editCanvas = document.getElementById('edit-canvas');
const pdfCtx = pdfCanvas ? pdfCanvas.getContext('2d') : null;
const editCtx = editCanvas ? editCanvas.getContext('2d') : null;
const pdfContainer = document.getElementById('pdf-container');
const canvasWrapper = document.getElementById('canvas-wrapper');
const pdfPage = document.getElementById('pdf-page');
const loadingOverlay = document.getElementById('loading-overlay');
const notification = document.getElementById('notification');
const editDialog = document.getElementById('edit-dialog');
const dialogInput = document.getElementById('dialog-input');
const dialogSave = document.getElementById('dialog-save');
const dialogCancel = document.getElementById('dialog-cancel');
const textColorInput = document.getElementById('text-color');
const bgColorInput = document.getElementById('bg-color');
const fontSizeInput = document.getElementById('font-size-input');
const transparentToggle = document.getElementById('transparent-toggle');
const pickBgBtn = document.getElementById('pick-bg-btn');
const boldBtn = document.getElementById('bold-btn');
const thinBtn = document.getElementById('thin-btn');
const fontSelect = document.getElementById('font-select');
const qualitySelect = document.getElementById('quality-select');
const imageInput = document.getElementById('image-input');
const yAdjustSlider = document.getElementById('y-adjust-slider');
const yAdjustValue = document.getElementById('y-adjust-value');
const coverHeightSlider = document.getElementById('cover-height-slider');
const coverHeightValue = document.getElementById('cover-height-value');
const coverYSlider = document.getElementById('cover-y-slider');
const coverYValue = document.getElementById('cover-y-value');
const boldThicknessSlider = document.getElementById('bold-thickness-slider');
const boldThicknessValue = document.getElementById('bold-thickness-value');
const openPdfBtn = document.getElementById('open-pdf-btn');
const pdfFileInput = document.getElementById('pdf-file-input');

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function isAdmin(user) {
    return user && user.email === ADMIN_EMAIL;
}

function isPremiumUser(user) {
    return user && user.email === ADMIN_EMAIL;
}

function startConnectionMonitoring() {
    if (connectionCheckInterval) clearInterval(connectionCheckInterval);
    
    connectionCheckInterval = setInterval(() => {
        const wasOnline = isOnline;
        isOnline = navigator.onLine;
        
        if (wasOnline !== isOnline) {
            if (isOnline) {
                showNotification('Connection restored', false);
                enableEditing();
            } else {
                showNotification('Connection lost', true);
                disableEditing();
            }
        }
    }, 3000);
    
    window.addEventListener('online', () => {
        isOnline = true;
        showNotification('Connection restored', false);
        enableEditing();
    });
    
    window.addEventListener('offline', () => {
        isOnline = false;
        showNotification('Connection lost', true);
        disableEditing();
    });
}

function disableEditing() {
    const buttons = ['save-btn', 'open-pdf-btn', 'dialog-save', 'prev-page', 'next-page', 'zoom-in', 'zoom-out'];
    buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        }
    });
    
    textBoxes.forEach(box => {
        box.style.pointerEvents = 'none';
        box.style.opacity = '0.5';
    });
    
    imageBoxes.forEach(box => {
        box.style.pointerEvents = 'none';
        box.style.opacity = '0.5';
    });
}

function enableEditing() {
    const user = auth.currentUser;
    if (!user) return;
    
    getRemainingEdits(user).then(() => {
        const buttons = ['save-btn', 'open-pdf-btn', 'dialog-save', 'prev-page', 'next-page', 'zoom-in', 'zoom-out'];
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
        
        textBoxes.forEach(box => {
            box.style.pointerEvents = 'auto';
            box.style.opacity = '1';
        });
        
        imageBoxes.forEach(box => {
            box.style.pointerEvents = 'auto';
            box.style.opacity = '1';
        });
    });
}

function showNotification(message, isPersistent = false) {
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    const notificationCancel = document.getElementById('notification-cancel');
    
    if (notification && notificationMessage) {
        notificationMessage.textContent = message;
        notification.classList.add('show');
        notification.classList.remove('error', 'warning');
        
        if (message.includes('Error') || message.includes('failed') || message.includes('No internet')) {
            notification.classList.add('error');
        } else if (message.includes('limit') || message.includes('Limit')) {
            notification.classList.add('warning');
        }
        
        if (notificationCancel) {
            if (isPersistent) {
                notificationCancel.style.display = 'block';
            } else {
                notificationCancel.style.display = 'none';
                setTimeout(() => notification.classList.remove('show'), 3000);
            }
        }
    }
}

function cancelNotification() {
    const notification = document.getElementById('notification');
    if (notification) notification.classList.remove('show');
}

function showLoading(show) {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) loadingOverlay.classList.toggle('show', show);
}

// ==========================================
// PROFESSIONAL DIALOG SYSTEM
// ==========================================
function createProfessionalDialog() {
    if (document.getElementById('professional-dialog')) return;
    
    const dialogHTML = `
        <div id="professional-dialog" class="professional-dialog" style="display: none;">
            <div class="dialog-content">
                <div class="dialog-icon" id="dialog-icon"></div>
                <h3 class="dialog-title" id="dialog-title">Information</h3>
                <p class="dialog-message" id="dialog-message"></p>
                <div class="dialog-progress" id="dialog-progress" style="display: none;">
                    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                    <div class="progress-text" id="progress-text"></div>
                </div>
                <div class="dialog-buttons" id="dialog-buttons">
                    <button class="dialog-btn-ok" id="dialog-ok-btn">OK</button>
                    <button class="dialog-btn-buy" id="dialog-buy-btn"><i class="fas fa-coins"></i> Buy Edits</button>
                </div>
                <button class="dialog-close" id="dialog-close"><i class="fas fa-times"></i></button>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = dialogHTML;
    document.body.appendChild(container.firstElementChild);
    
    document.getElementById('dialog-close').addEventListener('click', hideProfessionalDialog);
    document.getElementById('dialog-ok-btn').addEventListener('click', hideProfessionalDialog);
    document.getElementById('dialog-buy-btn').addEventListener('click', () => {
        hideProfessionalDialog();
        showPaymentDialog();
    });
    
    document.getElementById('professional-dialog').addEventListener('click', (e) => {
        if (e.target === document.getElementById('professional-dialog')) hideProfessionalDialog();
    });
}

function showProfessionalDialog(options = {}) {
    const { type = 'info', title = 'Information', message = '', showProgress = false, progressValue = 0, progressMax = 2, showBuyButton = true } = options;
    
    let dialog = document.getElementById('professional-dialog');
    if (!dialog) { createProfessionalDialog(); dialog = document.getElementById('professional-dialog'); }
    
    const iconMap = { info: '<i class="fas fa-info-circle" style="color: var(--primary);"></i>', success: '<i class="fas fa-check-circle" style="color: var(--success);"></i>', warning: '<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>', error: '<i class="fas fa-times-circle" style="color: var(--danger);"></i>', limit: '<i class="fas fa-chart-line" style="color: var(--warning);"></i>', premium: '<i class="fas fa-crown" style="color: var(--warning);"></i>' };
    document.getElementById('dialog-icon').innerHTML = iconMap[type] || iconMap.info;
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-message').textContent = message;
    
    const progressDiv = document.getElementById('dialog-progress');
    if (showProgress) {
        progressDiv.style.display = 'block';
        const percentage = (progressValue / progressMax) * 100;
        document.getElementById('progress-fill').style.width = percentage + '%';
        document.getElementById('progress-text').textContent = `${progressValue} of ${progressMax} edits used`;
    } else {
        progressDiv.style.display = 'none';
    }
    
    document.getElementById('dialog-buy-btn').style.display = showBuyButton ? 'block' : 'none';
    dialog.style.display = 'flex';
}

function hideProfessionalDialog() {
    const dialog = document.getElementById('professional-dialog');
    if (dialog) dialog.style.display = 'none';
}

// ==========================================
// PAYMENT SYSTEM
// ==========================================
function createPaymentDialog() {
    if (document.getElementById('payment-dialog')) return;
    
    const dialogHTML = `
        <div id="payment-dialog" class="payment-dialog" style="display: none;">
            <div class="payment-content">
                <div class="payment-header">
                    <h2><i class="fas fa-coins"></i> Buy Edits</h2>
                    <button class="payment-close" id="payment-close"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="payment-plans" id="payment-plans"></div>
                
                <div class="payment-upi" id="payment-upi" style="display: none;">
                    <h3>Pay via UPI</h3>
                    <div class="upi-options" id="upi-options"></div>
                    <div class="selected-upi" id="selected-upi"></div>
                </div>
                
                <div class="payment-screenshot" id="payment-screenshot" style="display: none;">
                    <h3>Upload Payment Screenshot</h3>
                    <div class="screenshot-preview" id="screenshot-preview"></div>
                    <input type="file" id="screenshot-input" accept="image/*" style="display: none;">
                    <button id="upload-screenshot-btn"><i class="fas fa-camera"></i> Choose Screenshot</button>
                    <p class="screenshot-info">Max size: 5MB (JPEG/PNG)</p>
                </div>
                
                <div class="payment-actions" id="payment-actions" style="display: none;">
                    <button class="payment-btn payment-back" id="payment-back"><i class="fas fa-arrow-left"></i> Back</button>
                    <button class="payment-btn payment-submit" id="payment-submit"><i class="fas fa-check"></i> Submit Payment</button>
                </div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = dialogHTML;
    document.body.appendChild(container.firstElementChild);
    
    document.getElementById('payment-close').addEventListener('click', hidePaymentDialog);
    document.getElementById('upload-screenshot-btn').addEventListener('click', () => {
        document.getElementById('screenshot-input').click();
    });
    
    document.getElementById('screenshot-input').addEventListener('change', handleScreenshotUpload);
    document.getElementById('payment-submit').addEventListener('click', submitPayment);
    document.getElementById('payment-back').addEventListener('click', showPaymentPlans);
    
    document.getElementById('payment-dialog').addEventListener('click', (e) => {
        if (e.target === document.getElementById('payment-dialog')) hidePaymentDialog();
    });
}

function showPaymentDialog() {
    let dialog = document.getElementById('payment-dialog');
    if (!dialog) { createPaymentDialog(); dialog = document.getElementById('payment-dialog'); }
    
    dialog.style.display = 'flex';
    showPaymentPlans();
}

function hidePaymentDialog() {
    const dialog = document.getElementById('payment-dialog');
    if (dialog) dialog.style.display = 'none';
}

function showPaymentPlans() {
    document.getElementById('payment-plans').style.display = 'grid';
    document.getElementById('payment-upi').style.display = 'none';
    document.getElementById('payment-screenshot').style.display = 'none';
    document.getElementById('payment-actions').style.display = 'none';
    
    const plansContainer = document.getElementById('payment-plans');
    plansContainer.innerHTML = '';
    
    Object.entries(PAYMENT_PLANS).forEach(([key, plan]) => {
        const planCard = document.createElement('div');
        planCard.className = `plan-card ${key === 'plan20' ? 'popular' : ''}`;
        planCard.innerHTML = `
            <div class="plan-price"><i class="fas fa-rupee-sign"></i>${plan.price}</div>
            <div class="plan-edits">${plan.edits} Edits</div>
            <div class="plan-name">${plan.name}</div>
            ${key === 'plan20' ? '<div class="popular-tag"><i class="fas fa-fire"></i> Popular</div>' : ''}
        `;
        planCard.addEventListener('click', (e) => selectPlan(key, e));
        plansContainer.appendChild(planCard);
    });
}

let selectedPlan = null;
let selectedUPI = null;
let screenshotData = null;

function selectPlan(planKey, event) {
    selectedPlan = PAYMENT_PLANS[planKey];
    
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    document.getElementById('payment-plans').style.display = 'none';
    document.getElementById('payment-upi').style.display = 'block';
    
    const upiOptions = document.getElementById('upi-options');
    upiOptions.innerHTML = '';
    
    Object.entries(UPI_OPTIONS).forEach(([key, upi]) => {
        const option = document.createElement('div');
        option.className = 'upi-option';
        option.innerHTML = `<strong>${upi.name}</strong><br><small>${upi.id}</small>`;
        option.addEventListener('click', (e) => selectUPI(key, e));
        upiOptions.appendChild(option);
    });
}

function selectUPI(upiKey, event) {
    selectedUPI = UPI_OPTIONS[upiKey];
    
    document.querySelectorAll('.upi-option').forEach(o => o.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    document.getElementById('selected-upi').innerHTML = `<strong>Pay to:</strong> ${selectedUPI.name}<br><span style="font-size: 1.1rem; color: var(--dark);">${selectedUPI.id}</span>`;
    
    document.getElementById('payment-screenshot').style.display = 'block';
    document.getElementById('payment-actions').style.display = 'flex';
}

function handleScreenshotUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('File too large. Max 5MB', true);
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        showNotification('Please select an image file', true);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (event) => {
        screenshotData = event.target.result;
        const preview = document.getElementById('screenshot-preview');
        preview.innerHTML = `<img src="${screenshotData}" alt="Screenshot Preview">`;
    };
    reader.readAsDataURL(file);
}

async function submitPayment() {
    if (!selectedPlan || !selectedUPI || !screenshotData) {
        showNotification('Please complete all steps', true);
        return;
    }
    
    const user = auth.currentUser;
    if (!user) {
        showNotification('Please login first', true);
        return;
    }
    
    showLoading(true);
    
    try {
        const paymentData = {
            userId: user.uid,
            userEmail: user.email,
            plan: selectedPlan,
            upi: selectedUPI,
            screenshot: screenshotData,
            status: 'pending',
            timestamp: new Date().toISOString()
        };
        
        await database.ref('payments/' + Date.now()).set(paymentData);
        
        showProfessionalDialog({
            type: 'success',
            title: 'Payment Submitted',
            message: `Your payment of ${selectedPlan.price} for ${selectedPlan.edits} edits has been submitted for approval.\n\nAdmin will verify and add credits within 24 hours.`,
            showBuyButton: false
        });
        
        hidePaymentDialog();
        
        selectedPlan = null;
        selectedUPI = null;
        screenshotData = null;
        
    } catch (error) {
        console.error('Payment submission error:', error);
        showNotification('Error submitting payment: ' + error.message, true);
    } finally {
        showLoading(false);
    }
}

// ==========================================
// ADMIN APPROVAL PANEL
// ==========================================
function createAdminPanel() {
    if (document.getElementById('admin-panel')) return;
    
    const panelHTML = `
        <div id="admin-panel" class="admin-panel" style="display: none;">
            <div class="admin-content">
                <div class="admin-header">
                    <h2><i class="fas fa-crown"></i> Admin Approval Panel</h2>
                    <button class="admin-close" id="admin-close"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="admin-stats" id="admin-stats"></div>
                
                <div class="admin-payments" id="admin-payments"></div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = panelHTML;
    document.body.appendChild(container.firstElementChild);
    
    document.getElementById('admin-close').addEventListener('click', hideAdminPanel);
}

function showAdminPanel() {
    const user = auth.currentUser;
    if (!isAdmin(user)) {
        showNotification('Admin access only', true);
        return;
    }
    
    let panel = document.getElementById('admin-panel');
    if (!panel) { createAdminPanel(); panel = document.getElementById('admin-panel'); }
    
    panel.style.display = 'flex';
    loadPendingPayments();
}

function hideAdminPanel() {
    const panel = document.getElementById('admin-panel');
    if (panel) panel.style.display = 'none';
}

async function loadPendingPayments() {
    try {
        const snapshot = await database.ref('payments').once('value');
        const payments = snapshot.val() || {};
        
        updateAdminStats(payments);
        
        const container = document.getElementById('admin-payments');
        container.innerHTML = '';
        
        const paymentsArray = Object.entries(payments).map(([id, data]) => ({ id, ...data }));
        const pendingPayments = paymentsArray.filter(p => p.status === 'pending');
        
        if (pendingPayments.length === 0) {
            container.innerHTML = '<div class="no-payments"><i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i><br>No pending payments</div>';
            return;
        }
        
        pendingPayments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        pendingPayments.forEach(payment => {
            const paymentEl = document.createElement('div');
            paymentEl.className = 'payment-item';
            paymentEl.innerHTML = `
                <div class="payment-header-info">
                    <span class="payment-user"><i class="fas fa-user"></i> ${payment.userEmail}</span>
                    <span class="payment-status status-pending">Pending</span>
                </div>
                <div class="payment-details">
                    <div><i class="fas fa-rupee-sign"></i> ${payment.plan.price}</div>
                    <div><i class="fas fa-edit"></i> ${payment.plan.edits} edits</div>
                    <div><i class="fas fa-mobile-alt"></i> ${payment.upi.name}</div>
                </div>
                <div class="payment-details">
                    <div>UPI ID: ${payment.upi.id}</div>
                    <div>Time: ${new Date(payment.timestamp).toLocaleString()}</div>
                </div>
                <img class="payment-screenshot" src="${payment.screenshot}" alt="Payment Screenshot" onclick="window.open(this.src, '_blank')">
                <div class="payment-actions">
                    <button class="action-btn approve-btn" onclick="approvePayment('${payment.id}', '${payment.userId}', ${payment.plan.edits})"><i class="fas fa-check"></i> Approve</button>
                    <button class="action-btn reject-btn" onclick="rejectPayment('${payment.id}')"><i class="fas fa-times"></i> Reject</button>
                </div>
            `;
            container.appendChild(paymentEl);
        });
        
    } catch (error) {
        console.error('Error loading payments:', error);
        showNotification('Error loading payments', true);
    }
}

function updateAdminStats(payments) {
    const paymentsArray = Object.values(payments);
    const totalPayments = paymentsArray.length;
    const pendingCount = paymentsArray.filter(p => p.status === 'pending').length;
    const approvedCount = paymentsArray.filter(p => p.status === 'approved').length;
    const totalRevenue = paymentsArray.filter(p => p.status === 'approved').reduce((sum, p) => sum + p.plan.price, 0);
    
    document.getElementById('admin-stats').innerHTML = `
        <div class="admin-stat-card">
            <div class="admin-stat-value">${totalPayments}</div>
            <div class="admin-stat-label">Total Payments</div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-value">${pendingCount}</div>
            <div class="admin-stat-label">Pending</div>
        </div>
        <div class="admin-stat-card">
            <div class="admin-stat-value">${totalRevenue}</div>
            <div class="admin-stat-label">Revenue</div>
        </div>
    `;
}

async function approvePayment(paymentId, userId, editsToAdd) {
    try {
        showLoading(true);
        
        await database.ref('payments/' + paymentId).update({ status: 'approved' });
        
        const userRef = database.ref('users/' + userId);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || { editCount: 0, maxEdits: 2 };
        
        const currentMaxEdits = userData.maxEdits || 2;
        const newMaxEdits = currentMaxEdits + editsToAdd;
        
        await userRef.update({
            maxEdits: newMaxEdits,
            lastPurchase: new Date().toISOString()
        });
        
        showProfessionalDialog({
            type: 'success',
            title: 'Payment Approved',
            message: `${editsToAdd} edits added to user account.\nNew total: ${newMaxEdits} edits`,
            showBuyButton: false
        });
        
        loadPendingPayments();
        
    } catch (error) {
        console.error('Error approving payment:', error);
        showNotification('Error approving payment', true);
    } finally {
        showLoading(false);
    }
}

async function rejectPayment(paymentId) {
    try {
        showLoading(true);
        
        await database.ref('payments/' + paymentId).update({ status: 'rejected' });
        
        showProfessionalDialog({
            type: 'warning',
            title: 'Payment Rejected',
            message: 'Payment has been rejected',
            showBuyButton: false
        });
        
        loadPendingPayments();
        
    } catch (error) {
        console.error('Error rejecting payment:', error);
        showNotification('Error rejecting payment', true);
    } finally {
        showLoading(false);
    }
}

// ==========================================
// USER CREDIT SYSTEM
// ==========================================
async function initializeUserEditCount(user) {
    if (!user || isAdmin(user)) return;
    
    const userRef = database.ref('users/' + user.uid);
    const snapshot = await userRef.once('value');
    
    if (!snapshot.exists()) {
        await userRef.set({
            email: user.email,
            editCount: 0,
            maxEdits: 2,
            createdAt: new Date().toISOString(),
            lastEdit: null
        });
    }
}

async function getRemainingEdits(user) {
    if (!user) return 0;
    if (isAdmin(user)) return 'Unlimited';
    
    const userRef = database.ref('users/' + user.uid);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val() || { editCount: 0, maxEdits: 2 };
    
    return userData.maxEdits - userData.editCount;
}

async function canUserEdit(user) {
    if (!user) return false;
    if (isAdmin(user)) return true;
    
    const userRef = database.ref('users/' + user.uid);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val() || { editCount: 0, maxEdits: 2 };
    
    return userData.editCount < userData.maxEdits;
}

async function incrementEditCount(user) {
    if (!user) return false;
    if (isAdmin(user)) return true;
    
    const userRef = database.ref('users/' + user.uid);
    const snapshot = await userRef.once('value');
    const userData = snapshot.val() || { editCount: 0, maxEdits: 2 };
    
    if (userData.editCount < userData.maxEdits) {
        const newCount = userData.editCount + 1;
        await userRef.update({
            editCount: newCount,
            lastEdit: new Date().toISOString()
        });
        
        const updatedData = { ...userData, editCount: newCount, email: user.email };
        updateUserDashboard(updatedData);
        
        return true;
    }
    return false;
}

// ==========================================
// PDF EDITOR FUNCTIONS
// ==========================================
function init() {
    setupEventListeners();
}

function setupEventListeners() {
    if (openPdfBtn && pdfFileInput) {
        openPdfBtn.addEventListener('click', async () => {
            if (!isOnline) {
                showNotification('No internet connection. Please check your network.', true);
                return;
            }
            if (!await checkEditLimitBeforeAction()) return;
            pdfFileInput.click();
        });
        pdfFileInput.addEventListener('change', handleFileUpload);
    }

    const prevPage = document.getElementById('prev-page');
    const nextPage = document.getElementById('next-page');
    
    if (prevPage) {
        prevPage.addEventListener('click', () => { 
            if (!isOnline) { showNotification('No internet connection', true); return; }
            if (pageNum > 1) { pageNum--; renderPage(pageNum); }
        });
    }
    
    if (nextPage) {
        nextPage.addEventListener('click', () => { 
            if (!isOnline) { showNotification('No internet connection', true); return; }
            if (pageNum < pageCount) { pageNum++; renderPage(pageNum); }
        });
    }
    
    const zoomIn = document.getElementById('zoom-in');
    const zoomOut = document.getElementById('zoom-out');
    
    if (zoomIn) zoomIn.addEventListener('click', () => { scale = Math.min(scale * 1.2, maxZoom); renderPage(pageNum); });
    if (zoomOut) zoomOut.addEventListener('click', () => { scale = Math.max(scale / 1.2, minZoom); renderPage(pageNum); });
    
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
            if (!isOnline) { showNotification('No internet connection. Cannot save PDF.', true); return; }
            if (!await checkEditLimitBeforeAction()) return;
            await savePDF();
        });
    }
    
    const fscreenBtn = document.getElementById('FScreen-btn');
    if (fscreenBtn) {
        fscreenBtn.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((e) => console.error(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        });
    }
    
    if (imageInput) imageInput.addEventListener('change', handleImageSelect);
    
    if (dialogSave) {
        dialogSave.addEventListener('click', async () => {
            if (!isOnline) { showNotification('No internet connection', true); closeDialog(); return; }
            if (!await checkEditLimitBeforeAction()) { closeDialog(); return; }
            await saveDialogText();
        });
    }
    if (dialogCancel) dialogCancel.addEventListener('click', closeDialog);
    
    if (dialogInput) {
        dialogInput.addEventListener('keydown', async (e) => { 
            if (e.key === 'Enter') {
                if (!isOnline) { showNotification('No internet connection', true); closeDialog(); return; }
                if (!await checkEditLimitBeforeAction()) { closeDialog(); return; }
                await saveDialogText();
            } else if (e.key === 'Escape') closeDialog();
        });
    }
    
    if (textColorInput) textColorInput.addEventListener('input', (e) => { currentTextColor = e.target.value; previewChanges(); });
    if (fontSizeInput) fontSizeInput.addEventListener('input', (e) => { currentFontSize = parseInt(e.target.value) || 12; previewChanges(); });
    
    if (yAdjustSlider) yAdjustSlider.addEventListener('input', (e) => { currentYAdjust = parseInt(e.target.value); if (yAdjustValue) yAdjustValue.textContent = currentYAdjust; previewChanges(); });
    if (coverHeightSlider) coverHeightSlider.addEventListener('input', (e) => { currentCoverHeight = parseInt(e.target.value); if (coverHeightValue) coverHeightValue.textContent = currentCoverHeight; previewChanges(); });
    if (coverYSlider) coverYSlider.addEventListener('input', (e) => { currentCoverY = parseInt(e.target.value); if (coverYValue) coverYValue.textContent = currentCoverY; previewChanges(); });
    
    if (boldThicknessSlider) {
        boldThicknessSlider.addEventListener('input', (e) => {
            currentBoldThickness = parseFloat(e.target.value);
            if (boldThicknessValue) boldThicknessValue.textContent = currentBoldThickness.toFixed(1);
            if (!currentTextBold && currentBoldThickness > 1.0) {
                currentTextBold = true;
                currentTextThin = false;
                if (boldBtn) boldBtn.classList.add('active');
                if (thinBtn) thinBtn.classList.remove('active');
            }
            previewChanges();
        });
    }

    if (bgColorInput) bgColorInput.addEventListener('input', (e) => { currentBgColor = e.target.value; isBgTransparent = false; updateTransparentUI(); previewChanges(); });
    if (transparentToggle) transparentToggle.addEventListener('click', () => { isBgTransparent = !isBgTransparent; updateTransparentUI(); previewChanges(); });
    if (pickBgBtn) pickBgBtn.addEventListener('click', pickBackgroundColor);
    
    if (boldBtn) {
        boldBtn.addEventListener('click', () => { 
            currentTextBold = !currentTextBold; 
            boldBtn.classList.toggle('active');
            if (currentTextBold) {
                currentTextThin = false;
                if (thinBtn) thinBtn.classList.remove('active');
                if (currentBoldThickness < 1.0) currentBoldThickness = 1.5;
            } else {
                currentBoldThickness = 1.0;
            }
            if (boldThicknessSlider) boldThicknessSlider.value = currentBoldThickness;
            if (boldThicknessValue) boldThicknessValue.textContent = currentBoldThickness.toFixed(1);
            previewChanges();
        });
    }
    
    if (thinBtn) {
        thinBtn.addEventListener('click', () => { 
            currentTextThin = !currentTextThin; 
            thinBtn.classList.toggle('active');
            if (currentTextThin) {
                currentTextBold = false;
                if (boldBtn) boldBtn.classList.remove('active');
                currentBoldThickness = 0.5;
            } else {
                currentBoldThickness = 1.0;
            }
            if (boldThicknessSlider) boldThicknessSlider.value = currentBoldThickness;
            if (boldThicknessValue) boldThicknessValue.textContent = currentBoldThickness.toFixed(1);
            previewChanges();
        });
    }
    
    if (fontSelect) {
        fontSelect.addEventListener('change', (e) => { 
            currentFontFamily = e.target.value;
            if (currentFontFamily === 'Roboto Thin') { currentTextThin = true; currentTextBold = false; currentBoldThickness = 0.5; }
            else if (currentFontFamily === 'Roboto Bold' || currentFontFamily === 'Roboto Black') { currentTextBold = true; currentTextThin = false; currentBoldThickness = 2.0; }
            else { currentTextBold = false; currentTextThin = false; currentBoldThickness = 1.0; }
            if (boldBtn) boldBtn.classList.toggle('active', currentTextBold);
            if (thinBtn) thinBtn.classList.toggle('active', currentTextThin);
            if (boldThicknessSlider) boldThicknessSlider.value = currentBoldThickness;
            if (boldThicknessValue) boldThicknessValue.textContent = currentBoldThickness.toFixed(1);
            previewChanges();
        });
    }
}

async function checkEditLimitBeforeAction() {
    const user = auth.currentUser;
    if (!user) {
        showNotification('Please login first');
        const loginModal = document.getElementById('login-modal');
        if (loginModal) loginModal.style.display = 'flex';
        return false;
    }
    
    if (!isOnline) { showNotification('No internet connection. Please check your network.', true); return false; }
    
    if (isAdmin(user)) return true;
    
    const canEdit = await canUserEdit(user);
    if (!canEdit) {
        const userRef = database.ref('users/' + user.uid);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || { maxEdits: 2 };
        
        showProfessionalDialog({
            type: 'warning',
            title: 'Edit Limit Reached',
            message: `You have used all ${userData.maxEdits} edits.\n\nBuy more edits to continue!`,
            showProgress: true,
            progressValue: userData.maxEdits,
            progressMax: userData.maxEdits,
            showBuyButton: true
        });
        return false;
    }
    
    return true;
}

function updateTransparentUI() {
    if (!transparentToggle || !bgColorInput) return;
    if (isBgTransparent) { transparentToggle.classList.add('active'); bgColorInput.disabled = true; bgColorInput.style.opacity = 0.5; }
    else { transparentToggle.classList.remove('active'); bgColorInput.disabled = false; bgColorInput.style.opacity = 1; }
}

function previewChanges() {
    if (!currentEditingTextItem) return;
    currentEditingTextItem.text = dialogInput ? (dialogInput.value || currentEditingTextItem.text) : currentEditingTextItem.text;
    currentEditingTextItem.color = currentTextColor;
    currentEditingTextItem.fontFamily = currentFontFamily;
    currentEditingTextItem.fontSize = currentFontSize * scale;
    currentEditingTextItem.isBold = currentTextBold;
    currentEditingTextItem.isThin = currentTextThin;
    currentEditingTextItem.boldThickness = currentBoldThickness;
    currentEditingTextItem.yAdjust = currentYAdjust;
    currentEditingTextItem.coverHeight = currentCoverHeight;
    currentEditingTextItem.coverY = currentCoverY;
    currentEditingTextItem.bgColor = isBgTransparent ? 'transparent' : currentBgColor;
    redrawEditedContent();
}

async function handleFileUpload(e) {
    if (!auth.currentUser) {
        showNotification('Please login first');
        const loginModal = document.getElementById('login-modal');
        if (loginModal) loginModal.style.display = 'flex';
        return;
    }
    
    if (!isOnline) { showNotification('No internet connection. Cannot load PDF.', true); return; }
    
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') { showNotification('Please select a valid PDF file.'); return; }

    showLoading(true);
    showNotification('Loading PDF, please wait...');

    const fileReader = new FileReader();
    fileReader.onload = async function() {
        const typedarray = new Uint8Array(this.result);
        try {
            allPageEdits = {};
            originalTextStyles = {};
            formFields = {};
            imageItems = [];
            imageBoxes = [];
            currentEditingImageItem = null;
            editInProgress = false;

            const loadingTask = pdfjsLib.getDocument(typedarray);
            loadingTask.promise.then(function(pdf) {
                pdfDoc = pdf;
                pageCount = pdf.numPages;
                pageNum = 1;
                renderPage(pageNum);
                showNotification(`"${file.name}" loaded successfully.`);
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                showNotification('Error parsing PDF: ' + error.message);
                showLoading(false);
            });
        } catch (error) {
            console.error('Error processing file:', error);
            showNotification('Error processing file: ' + error.message);
            showLoading(false);
        }
    };
    fileReader.onerror = function() { showNotification('Error reading file.'); showLoading(false); };
    fileReader.readAsArrayBuffer(file);
    e.target.value = '';
}

function renderPage(num) {
    if (!auth.currentUser) { const loginModal = document.getElementById('login-modal'); if (loginModal) loginModal.style.display = 'flex'; return; }
    if (!pdfDoc) return;
    
    showLoading(true);
    clearTextBoxes();
    clearImageBoxes();
    
    pdfDoc.getPage(num).then(page => {
        currentViewport = page.getViewport({ scale: scale });
        originalPageSize = { width: currentViewport.width, height: currentViewport.height };
        if (pdfCanvas) { pdfCanvas.width = currentViewport.width; pdfCanvas.height = currentViewport.height; }
        if (editCanvas) { editCanvas.width = currentViewport.width; editCanvas.height = currentViewport.height; }
        if (canvasWrapper) { canvasWrapper.style.width = currentViewport.width + 'px'; canvasWrapper.style.height = currentViewport.height + 'px'; }
        const renderContext = { canvasContext: pdfCtx, viewport: currentViewport };
        return page.render(renderContext).promise;
    }).then(() => {
        return pdfDoc.getPage(pageNum).then(page => page.getTextContent({ normalizeWhitespace: false, disableCombineTextItems: false }));
    }).then(textContent => {
        const pageEdits = allPageEdits[pageNum] || { textEdits: [], images: [] };
        const newTextItems = [];
        if (textContent && textContent.items) {
            const allTextItems = [];
            textContent.items.forEach((item, index) => {
                if (item.str && item.str.trim() !== '') {
                    const transform = item.transform;
                    const tx = pdfjsLib.Util.transform(currentViewport.transform, transform);
                    allTextItems.push({
                        text: item.str, x: tx[4], y: tx[5], width: item.width * scale, height: (item.height || 12) * scale,
                        fontSize: (item.height || 12) * scale, originalIndex: index, item: item
                    });
                }
            });
            const groupedTextItems = groupTextItems(allTextItems);
            groupedTextItems.forEach((item, index) => {
                const itemKey = `${pageNum}_${index}`;
                if (!originalTextStyles[itemKey]) originalTextStyles[itemKey] = extractTextStyles(item.item);
                const existingEdit = pageEdits.textEdits.find(edit => edit.originalIndex === index);
                const finalStyles = existingEdit ? {
                    color: existingEdit.color || originalTextStyles[itemKey].color, bgColor: existingEdit.bgColor || '#ffffff',
                    fontFamily: existingEdit.fontFamily || originalTextStyles[itemKey].fontFamily, fontWeight: existingEdit.fontWeight || originalTextStyles[itemKey].fontWeight,
                    isBold: existingEdit.isBold !== undefined ? existingEdit.isBold : originalTextStyles[itemKey].isBold,
                    isThin: existingEdit.isThin !== undefined ? existingEdit.isThin : originalTextStyles[itemKey].isThin,
                    fontSize: existingEdit.fontSize || item.fontSize, boldThickness: existingEdit.boldThickness !== undefined ? existingEdit.boldThickness : 1.0,
                    yAdjust: existingEdit.yAdjust || 0, coverHeight: existingEdit.coverHeight || 0, coverY: existingEdit.coverY || 0
                } : { ...originalTextStyles[itemKey], bgColor: '#ffffff', fontSize: item.fontSize, boldThickness: 1.0, yAdjust: 0, coverHeight: 0, coverY: 0 };
                newTextItems.push({
                    text: existingEdit ? existingEdit.text : item.text, x: item.x, y: item.y, width: item.width, height: item.height,
                    fontSize: finalStyles.fontSize, originalIndex: index, edited: !!existingEdit, color: finalStyles.color, bgColor: finalStyles.bgColor,
                    fontFamily: finalStyles.fontFamily, fontWeight: finalStyles.fontWeight, isBold: finalStyles.isBold, isThin: finalStyles.isThin,
                    boldThickness: finalStyles.boldThickness, originalIndices: item.originalIndices || [index], yAdjust: finalStyles.yAdjust,
                    coverHeight: finalStyles.coverHeight, coverY: finalStyles.coverY
                });
            });
        }
        textItems = newTextItems;
        createTextBoxes();
        return pdfDoc.getPage(pageNum).then(page => page.getOperatorList());
    }).then(operatorList => {
        const pageEdits = allPageEdits[pageNum] || { textEdits: [], images: [] };
        const newImageItems = [];
        let imageIndex = 0;
        if (operatorList && operatorList.fnArray) {
            for (let i = 0; i < operatorList.fnArray.length; i++) {
                if (operatorList.fnArray[i] === pdfjsLib.OPS.paintImageXObject) {
                    for (let j = i - 1; j >= 0; j--) {
                        if (operatorList.fnArray[j] === pdfjsLib.OPS.transform) {
                            const transform = operatorList.argsArray[j];
                            const [a, b, c, d, e, f] = transform;
                            const imageWidth = Math.sqrt(a * a + b * b) * scale;
                            const imageHeight = Math.sqrt(c * c + d * d) * scale;
                            const x = e * scale;
                            const y = (currentViewport.height - f * scale - imageHeight);
                            const existingEdit = pageEdits.images.find(edit => edit.index === imageIndex);
                            newImageItems.push({ index: imageIndex, x: x, y: y, width: imageWidth, height: imageHeight, edited: !!existingEdit, newImageData: existingEdit ? existingEdit.data : null });
                            imageIndex++;
                            break;
                        }
                    }
                }
            }
        }
        imageItems = newImageItems;
        createImageBoxes();
        redrawEditedContent();
        showLoading(false);
    }).catch(error => {
        console.error('Error rendering page:', error);
        showNotification('Error rendering page: ' + error.message);
        showLoading(false);
    });
    updatePageInfo();
    updateZoomLevel();
}

function groupTextItems(allTextItems) {
    const groupedItems = [];
    const processed = new Set();
    for (let i = 0; i < allTextItems.length; i++) {
        if (processed.has(i)) continue;
        const currentItem = allTextItems[i];
        let groupItem = { ...currentItem, originalIndices: [i] };
        if (i < allTextItems.length - 1) {
            const nextItem = allTextItems[i + 1];
            const xDistance = Math.abs(nextItem.x - (currentItem.x + currentItem.width));
            const yDistance = Math.abs(nextItem.y - currentItem.y);
            if (xDistance < 20 && yDistance < 5) {
                groupItem.text += nextItem.text;
                groupItem.width = nextItem.x + nextItem.width - currentItem.x;
                groupItem.originalIndices.push(i + 1);
                processed.add(i + 1);
            }
        }
        groupedItems.push(groupItem);
        processed.add(i);
    }
    return groupedItems;
}

function extractTextStyles(item) {
    const styles = { color: '#000000', fontFamily: 'Roboto', fontWeight: 'normal', isBold: false, isThin: false };
    if (item.color && Array.isArray(item.color) && item.color.length >= 3) {
        const r = Math.round(item.color[0] * 255), g = Math.round(item.color[1] * 255), b = Math.round(item.color[2] * 255);
        styles.color = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    if (item.fontName) {
        const fontName = item.fontName.toLowerCase();
        if (fontName.includes('helvetica') || fontName.includes('arial')) styles.fontFamily = 'Arial';
        else if (fontName.includes('times')) styles.fontFamily = 'Times New Roman';
        else if (fontName.includes('courier')) styles.fontFamily = 'Courier New';
        if (fontName.includes('bold') || fontName.includes('black')) { styles.fontWeight = 'bold'; styles.isBold = true; }
        else if (fontName.includes('thin') || fontName.includes('light')) { styles.fontWeight = 'thin'; styles.isThin = true; }
    }
    return styles;
}

function createTextBoxes() {
    if (!pdfPage || !canvasWrapper) return;
    const pdfPageRect = pdfPage.getBoundingClientRect();
    const canvasRect = canvasWrapper.getBoundingClientRect();
    textItems.forEach((item) => {
        const textBox = document.createElement('div');
        textBox.className = 'text-box' + (item.edited ? ' edited' : '');
        textBox.dataset.index = item.originalIndex;
        textBox.title = item.text;
        textBox.style.left = ((canvasRect.left - pdfPageRect.left) + item.x) + 'px';
        textBox.style.top = ((canvasRect.top - pdfPageRect.top) + (item.y - item.height)) + 'px';
        textBox.style.width = item.width + 'px';
        textBox.style.height = item.height + 'px';
        textBox.addEventListener('click', async (e) => { 
            e.stopPropagation(); 
            if (!isOnline) { showNotification('No internet connection', true); return; }
            if (!await checkEditLimitBeforeAction()) return;
            editText(item, textBox); 
        });
        pdfPage.appendChild(textBox);
        textBoxes.push(textBox);
    });
}

function createImageBoxes() {
    if (!pdfPage || !canvasWrapper) return;
    const pdfPageRect = pdfPage.getBoundingClientRect();
    const canvasRect = canvasWrapper.getBoundingClientRect();
    imageItems.forEach((item) => {
        const imageBox = document.createElement('div');
        imageBox.className = 'image-box' + (item.edited ? ' edited' : '');
        imageBox.style.left = ((canvasRect.left - pdfPageRect.left) + item.x) + 'px';
        imageBox.style.top = ((canvasRect.top - pdfPageRect.top) + item.y) + 'px';
        imageBox.style.width = item.width + 'px';
        imageBox.style.height = item.height + 'px';
        imageBox.addEventListener('click', async (e) => { 
            e.stopPropagation(); 
            if (!isOnline) { showNotification('No internet connection', true); return; }
            if (!await checkEditLimitBeforeAction()) return;
            replaceImage(item, imageBox); 
        });
        pdfPage.appendChild(imageBox);
        imageBoxes.push(imageBox);
    });
}

function replaceImage(imageItem, imageBoxElement) {
    currentEditingImageItem = { ...imageItem, box: imageBoxElement };
    if (imageInput) imageInput.click();
}

async function handleImageSelect(e) {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/') || !currentEditingImageItem) return;
    if (!isOnline) { showNotification('No internet connection', true); return; }
    if (!currentEditingImageItem.edited && auth.currentUser) {
        const incremented = await incrementEditCount(auth.currentUser);
        if (!incremented && !isAdmin(auth.currentUser)) { showNotification('Edit limit reached!', true); return; }
    }
    const reader = new FileReader();
    reader.onload = (event) => {
        const imageData = event.target.result;
        const itemIndex = currentEditingImageItem.index;
        if (!allPageEdits[pageNum]) allPageEdits[pageNum] = { textEdits: [], images: [] };
        const pageEdits = allPageEdits[pageNum];
        const existingImageEdit = pageEdits.images.find(edit => edit.index === itemIndex);
        if (existingImageEdit) existingImageEdit.data = imageData;
        else pageEdits.images.push({ index: itemIndex, data: imageData });
        const imageItem = imageItems.find(item => item.index === itemIndex);
        if (imageItem) { imageItem.edited = true; imageItem.newImageData = imageData; }
        redrawEditedContent();
        if (currentEditingImageItem.box) currentEditingImageItem.box.classList.add('edited');
        showNotification('Image replaced and saved.');
    };
    reader.readAsDataURL(file);
    if (imageInput) imageInput.value = '';
}

function clearTextBoxes() { textBoxes.forEach(textBox => textBox.remove()); textBoxes = []; }
function clearImageBoxes() { imageBoxes.forEach(box => { if (box && box.parentNode) box.parentNode.removeChild(box); }); imageBoxes = []; document.querySelectorAll('.image-box').forEach(box => box.remove()); currentEditingImageItem = null; }

function editText(textItem, textBoxElement) {
    if (!textItem) return;
    if (currentEditingTextItem === textItem) return;
    currentEditingTextItem = textItem;
    currentEditingTextBox = textBoxElement;
    if (dialogInput) dialogInput.value = textItem.text;
    if (textColorInput) textColorInput.value = textItem.color;
    let displaySize = Math.round(textItem.fontSize / scale);
    if (displaySize < 4) displaySize = 12;
    if (fontSizeInput) fontSizeInput.value = displaySize;
    currentFontSize = displaySize;
    currentYAdjust = textItem.yAdjust || 0;
    if (yAdjustSlider) yAdjustSlider.value = currentYAdjust;
    if (yAdjustValue) yAdjustValue.textContent = currentYAdjust;
    currentCoverHeight = textItem.coverHeight || 0;
    if (coverHeightSlider) coverHeightSlider.value = currentCoverHeight;
    if (coverHeightValue) coverHeightValue.textContent = currentCoverHeight;
    currentCoverY = textItem.coverY || 0;
    if (coverYSlider) coverYSlider.value = currentCoverY;
    if (coverYValue) coverYValue.textContent = currentCoverY;
    currentBoldThickness = textItem.boldThickness !== undefined ? textItem.boldThickness : 1.0;
    if (boldThicknessSlider) boldThicknessSlider.value = currentBoldThickness;
    if (boldThicknessValue) boldThicknessValue.textContent = currentBoldThickness.toFixed(1);
    if (textItem.bgColor === 'transparent') { isBgTransparent = true; currentBgColor = '#ffffff'; }
    else { isBgTransparent = false; currentBgColor = textItem.bgColor || '#ffffff'; }
    if (bgColorInput) bgColorInput.value = currentBgColor;
    updateTransparentUI();
    if (fontSelect) fontSelect.value = textItem.fontFamily;
    currentFontFamily = textItem.fontFamily;
    if (textItem.isThin) { currentTextThin = true; currentTextBold = false; if (thinBtn) thinBtn.classList.add('active'); if (boldBtn) boldBtn.classList.remove('active'); }
    else if (textItem.isBold) { currentTextBold = true; currentTextThin = false; if (boldBtn) boldBtn.classList.add('active'); if (thinBtn) thinBtn.classList.remove('active'); }
    else { currentTextBold = false; currentTextThin = false; if (boldBtn) boldBtn.classList.remove('active'); if (thinBtn) thinBtn.classList.remove('active'); }
    if (editDialog) editDialog.style.display = 'block';
    if (dialogInput) { dialogInput.focus(); dialogInput.select(); }
    autoHideOriginalText(textItem);
}

function autoHideOriginalText(textItem) {
    if (isBgTransparent || !pdfCtx) return;
    const sampleX = Math.max(0, Math.floor(textItem.x));
    const sampleY = Math.max(0, Math.floor(textItem.y - textItem.height / 2));
    try {
        const pixel = pdfCtx.getImageData(sampleX, sampleY, 1, 1).data;
        const bgHex = '#' + [pixel[0], pixel[1], pixel[2]].map(x => x.toString(16).padStart(2, '0')).join('');
        textItem.bgColor = bgHex;
        currentBgColor = bgHex;
        if (bgColorInput) bgColorInput.value = bgHex;
        previewChanges();
    } catch(e) {}
}

async function saveDialogText() {
    if (dialogInput && dialogInput.value.trim() && currentEditingTextItem) {
        if (!isOnline) { showNotification('No internet connection', true); closeDialog(); return; }
        if (!currentEditingTextItem.edited && auth.currentUser) {
            const incremented = await incrementEditCount(auth.currentUser);
            if (!incremented && !isAdmin(auth.currentUser)) { showNotification('Edit limit reached!', true); closeDialog(); return; }
        }
        currentEditingTextItem.text = dialogInput.value;
        if (textColorInput) currentEditingTextItem.color = textColorInput.value;
        currentEditingTextItem.bgColor = isBgTransparent ? 'transparent' : currentBgColor;
        currentEditingTextItem.fontFamily = currentFontFamily;
        currentEditingTextItem.fontSize = currentFontSize * scale;
        currentEditingTextItem.isBold = currentTextBold;
        currentEditingTextItem.isThin = currentTextThin;
        currentEditingTextItem.boldThickness = currentBoldThickness;
        currentEditingTextItem.yAdjust = currentYAdjust;
        currentEditingTextItem.coverHeight = currentCoverHeight;
        currentEditingTextItem.coverY = currentCoverY;
        currentEditingTextItem.fontWeight = currentTextBold ? '700' : (currentTextThin ? '300' : '400');
        currentEditingTextItem.edited = true;
        updateTextItem(currentEditingTextItem);
        redrawEditedContent();
        if (currentEditingTextBox) currentEditingTextBox.classList.add('edited');
        showNotification('Text updated successfully');
    }
    closeDialog();
}

function updateTextItem(textItem) {
    if (!allPageEdits[pageNum]) allPageEdits[pageNum] = { textEdits: [], images: [] };
    const pageEditList = allPageEdits[pageNum].textEdits;
    const editIndex = pageEditList.findIndex(edit => edit.originalIndex === textItem.originalIndex);
    const editData = {
        originalIndex: textItem.originalIndex, text: textItem.text, color: textItem.color, bgColor: textItem.bgColor,
        fontFamily: textItem.fontFamily, fontWeight: textItem.fontWeight, isBold: textItem.isBold, isThin: textItem.isThin,
        boldThickness: textItem.boldThickness, original_indices: textItem.original_indices, x: textItem.x, y: textItem.y,
        width: textItem.width, height: textItem.height, fontSize: textItem.fontSize, yAdjust: textItem.yAdjust,
        coverHeight: textItem.coverHeight, coverY: textItem.coverY
    };
    if (editIndex > -1) pageEditList[editIndex] = editData;
    else pageEditList.push(editData);
    const textBox = textBoxes.find(box => box && parseInt(box.dataset.index) === textItem.originalIndex);
    if (textBox) { textBox.classList.add('edited'); textBox.title = textItem.text; }
    updateTextBoxes();
    redrawEditedContent();
}

function redrawEditedContent() {
    if (!editCtx || !editCanvas) return;
    editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
    textItems.forEach(item => {
        if (item.edited) {
            editCtx.save();
            let fontWeight = item.isThin ? '300' : (item.isBold ? '700' : '400');
            editCtx.font = `${fontWeight} ${item.fontSize}px ${item.fontFamily}`;
            const baselineY = item.y;
            const metrics = editCtx.measureText(item.text);
            const ascent = metrics.actualBoundingBoxAscent || item.fontSize * 0.9;
            const descent = metrics.actualBoundingBoxDescent || item.fontSize * 0.2;
            const trueTopY = baselineY - ascent;
            const trueHeight = ascent + descent;
            const trueWidth = Math.max(item.width, metrics.width);
            if (item.bgColor && item.bgColor !== 'transparent') {
                editCtx.fillStyle = item.bgColor;
                const heightScale = item.fontSize / 50;
                const yScale = item.fontSize / 50;
                const coverExtra = (item.coverHeight || 0) * heightScale;
                const coverYShift = (item.coverY || 0) * yScale;
                editCtx.fillRect(item.x - 2, trueTopY - 2 - coverExtra + coverYShift, trueWidth + 4, trueHeight + 4 + (coverExtra * 2));
            }
            editCtx.fillStyle = item.color;
            editCtx.textBaseline = 'alphabetic';
            const yCorrection = (item.yAdjust || 0) * (item.fontSize / 100);
            const thickness = item.boldThickness || 1.0;
            if (thickness > 1.0 && item.isBold) {
                editCtx.lineWidth = thickness * (item.fontSize / 100);
                editCtx.strokeStyle = item.color;
                editCtx.strokeText(item.text, item.x, baselineY - yCorrection);
                editCtx.fillText(item.text, item.x, baselineY - yCorrection);
            } else if (thickness < 1.0 && item.isThin) {
                editCtx.font = `300 ${item.fontSize}px ${item.fontFamily}`;
                editCtx.fillText(item.text, item.x, baselineY - yCorrection);
            } else {
                editCtx.fillText(item.text, item.x, baselineY - yCorrection);
            }
            editCtx.restore();
        }
    });
    imageItems.forEach(item => {
        if (item.edited && item.newImageData) {
            const img = new Image();
            img.onload = () => { if (editCtx) editCtx.drawImage(img, item.x, item.y, item.width, item.height); };
            img.src = item.newImageData;
        }
    });
}

function closeDialog() {
    if (editDialog) editDialog.style.display = 'none';
    currentEditingTextItem = null;
    currentEditingTextBox = null;
    redrawEditedContent();
}

function pickBackgroundColor() {
    if (!currentEditingTextItem || !pdfCtx) return;
    const item = currentEditingTextItem;
    const x = Math.floor(item.x);
    const y = Math.floor(item.y - item.height/2);
    try {
        const pixel = pdfCtx.getImageData(x, y, 1, 1).data;
        const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(x => x.toString(16).padStart(2, '0')).join('');
        currentBgColor = hex;
        isBgTransparent = false;
        updateTransparentUI();
        if (bgColorInput) bgColorInput.value = hex;
        previewChanges();
        showNotification('Background color picked');
    } catch(e) { showNotification('Could not pick color'); }
}

function addWatermarkToCanvas(ctx, width, height) {
    if (!watermarkSettings.enabled) return;
    ctx.save();
    ctx.globalAlpha = watermarkSettings.opacity;
    const fontSize = Math.min(watermarkSettings.fontSize, width / 8);
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillStyle = watermarkSettings.color;
    if (watermarkSettings.outline) { ctx.strokeStyle = watermarkSettings.outlineColor; ctx.lineWidth = 3; }
    const text = watermarkSettings.text;
    const metrics = ctx.measureText(text);
    const textWidth = metrics.width;
    const textHeight = fontSize;
    ctx.save();
    ctx.translate(width / 2, height / 2);
    ctx.rotate(watermarkSettings.angle * Math.PI / 180);
    if (watermarkSettings.outline) ctx.strokeText(text, -textWidth / 2, -textHeight / 2);
    ctx.fillText(text, -textWidth / 2, -textHeight / 2);
    ctx.restore();
    ctx.restore();
}

async function savePDF() {
    if (!auth.currentUser) { showNotification('Please login first'); const loginModal = document.getElementById('login-modal'); if (loginModal) loginModal.style.display = 'flex'; return; }
    if (!pdfDoc) { showNotification('No PDF to save'); return; }
    if (!isOnline) { showNotification('No internet connection. Cannot save PDF.', true); return; }
    const hasEdits = Object.values(allPageEdits).some(page => (page.textEdits && page.textEdits.length > 0) || (page.images && page.images.length > 0));
    if (hasEdits && !isAdmin(auth.currentUser)) {
        const incremented = await incrementEditCount(auth.currentUser);
        if (!incremented) { showNotification('Edit limit reached!', true); return; }
    }
    showLoading(true);
    try {
        const quality = qualitySelect ? qualitySelect.value : 'HD';
        let outputScale = 5.0;
        switch (quality) { case 'standard': outputScale = 1.5; break; case 'high': outputScale = 2.0; break; case 'ultra': outputScale = 3.0; break; case 'HD': outputScale = 5.0; break; case 'pc': outputScale = 8.0; break; case 'ultraHD': outputScale = 10.0; break; }
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        const pageImages = [];
        
        async function renderAllPages() {
            for (let i = 1; i <= pageCount; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: outputScale });
                tempCanvas.width = viewport.width;
                tempCanvas.height = viewport.height;
                const renderContext = { canvasContext: tempCtx, viewport: viewport, intent: 'print' };
                await page.render(renderContext).promise;
                const pageEdits = allPageEdits[i] || { textEdits: [], images: [] };
                const textContent = await page.getTextContent({ normalizeWhitespace: false, disableCombineTextItems: false });
                if (textContent && textContent.items && pageEdits.textEdits.length > 0) {
                    const allTextItems = [];
                    textContent.items.forEach((item, index) => {
                        if (item.str && item.str.trim() !== '') {
                            const transform = item.transform;
                            const tx = pdfjsLib.Util.transform(viewport.transform, transform);
                            allTextItems.push({ text: item.str, x: tx[4], y: tx[5], width: item.width * outputScale, height: (item.height || transform[0]) * outputScale, fontSize: Math.abs(transform[0]) * outputScale, originalIndex: index });
                        }
                    });
                    const groupedItems = groupTextItemsForSave(allTextItems);
                    groupedItems.forEach((groupedItem, groupIndex) => {
                        const edit = pageEdits.textEdits.find(e => e.originalIndex === groupIndex);
                        if (edit) {
                            let fontWeight = edit.isThin ? '300' : (edit.isBold ? '700' : '400');
                            let renderFontSize = edit.fontSize ? (edit.fontSize / scale) * outputScale : groupedItem.fontSize;
                            tempCtx.font = `${fontWeight} ${renderFontSize}px ${edit.fontFamily || 'Roboto'}`;
                            const baselineY = groupedItem.y;
                            const metrics = tempCtx.measureText(edit.text);
                            const ascent = metrics.actualBoundingBoxAscent || renderFontSize * 0.9;
                            const descent = metrics.actualBoundingBoxDescent || renderFontSize * 0.2;
                            const trueTopY = baselineY - ascent;
                            const trueHeight = ascent + descent;
                            const trueWidth = Math.max(groupedItem.width, metrics.width);
                            let bgColor = edit.bgColor;
                            if (!bgColor || bgColor === 'transparent') bgColor = '#ffffff';
                            tempCtx.fillStyle = bgColor;
                            const heightScale = renderFontSize / 50;
                            const yScale = renderFontSize / 50;
                            const coverExtra = (edit.coverHeight || 0) * heightScale;
                            const coverYShift = (edit.coverY || 0) * yScale;
                            tempCtx.fillRect(groupedItem.x - 2, trueTopY - 2 - coverExtra + coverYShift, trueWidth + 4, trueHeight + 4 + (coverExtra * 2));
                            tempCtx.fillStyle = edit.color || '#000000';
                            tempCtx.textBaseline = 'alphabetic';
                            const yCorrection = (edit.yAdjust || 0) * (renderFontSize / 100);
                            const thickness = edit.boldThickness || 1.0;
                            if (thickness > 1.0 && edit.isBold) {
                                tempCtx.lineWidth = thickness * (renderFontSize / 100);
                                tempCtx.strokeStyle = edit.color || '#000000';
                                tempCtx.strokeText(edit.text, groupedItem.x, baselineY - yCorrection);
                                tempCtx.fillText(edit.text, groupedItem.x, baselineY - yCorrection);
                            } else if (thickness < 1.0 && edit.isThin) {
                                tempCtx.font = `300 ${renderFontSize}px ${edit.fontFamily || 'Roboto'}`;
                                tempCtx.fillText(edit.text, groupedItem.x, baselineY - yCorrection);
                            } else {
                                tempCtx.fillText(edit.text, groupedItem.x, baselineY - yCorrection);
                            }
                        }
                    });
                }
                if (pageEdits.images && pageEdits.images.length > 0) {
                    const operatorList = await page.getOperatorList();
                    let imageIndex = 0;
                    for (let j = 0; j < operatorList.fnArray.length; j++) {
                        if (operatorList.fnArray[j] === pdfjsLib.OPS.paintImageXObject) {
                            const imageEdit = pageEdits.images.find(edit => edit.index === imageIndex);
                            if (imageEdit && imageEdit.data) {
                                for (let k = j - 1; k >= 0; k--) {
                                    if (operatorList.fnArray[k] === pdfjsLib.OPS.transform) {
                                        const transform = operatorList.argsArray[k];
                                        const [a, b, c, d, e, f] = transform;
                                        const imgWidth = Math.sqrt(a * a + b * b) * outputScale;
                                        const imgHeight = Math.sqrt(c * c + d * d) * outputScale;
                                        const x = e * outputScale;
                                        const y = viewport.height - (f * outputScale) - imgHeight;
                                        const img = new Image();
                                        img.src = imageEdit.data;
                                        await new Promise(resolve => { img.onload = () => { tempCtx.drawImage(img, x, y, imgWidth, imgHeight); resolve(); }; });
                                        break;
                                    }
                                }
                            }
                            imageIndex++;
                        }
                    }
                }
                addWatermarkToCanvas(tempCtx, viewport.width, viewport.height);
                const imgData = tempCanvas.toDataURL('image/jpeg', 1.0);
                pageImages.push(imgData);
            }
            const { jsPDF } = window.jspdf;
            const firstPage = await pdfDoc.getPage(1);
            const firstViewport = firstPage.getViewport({ scale: 1.0 });
            const pdfWidth = firstViewport.width * 0.352778;
            const pdfHeight = firstViewport.height * 0.352778;
            const pdf = new jsPDF({ orientation: pdfWidth > pdfHeight ? 'landscape' : 'portrait', unit: 'mm', format: [pdfWidth, pdfHeight], compress: true });
            for (let i = 0; i < pageImages.length; i++) {
                if (i > 0) pdf.addPage([pdfWidth, pdfHeight]);
                pdf.addImage(pageImages[i], 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
            }
            pdf.save('edited-document.pdf');
            const user = auth.currentUser;
            if (!isAdmin(user)) {
                const userRef = database.ref('users/' + user.uid);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val() || { editCount: 0, maxEdits: 2 };
                const remaining = userData.maxEdits - userData.editCount;
                if (remaining > 0) {
                    showProfessionalDialog({ type: 'success', title: 'PDF Saved!', message: `PDF saved successfully!\n\nYou have ${remaining} edits remaining.`, showProgress: true, progressValue: userData.editCount, progressMax: userData.maxEdits, showBuyButton: false });
                } else {
                    showProfessionalDialog({ type: 'warning', title: 'PDF Saved - Limit Reached', message: `PDF saved!\n\nYou have used all ${userData.maxEdits} edits. Buy more to continue!`, showProgress: true, progressValue: userData.maxEdits, progressMax: userData.maxEdits, showBuyButton: true });
                }
            } else {
                showProfessionalDialog({ type: 'success', title: 'PDF Saved!', message: 'PDF saved successfully with admin privileges!', showBuyButton: false });
            }
        }
        
        function groupTextItemsForSave(allTextItems) {
            const groupedItems = [];
            const processed = new Set();
            for (let i = 0; i < allTextItems.length; i++) {
                if (processed.has(i)) continue;
                const currentItem = allTextItems[i];
                let groupItem = { ...currentItem, originalIndices: [i] };
                if (i < allTextItems.length - 1) {
                    const nextItem = allTextItems[i + 1];
                    const xDistance = Math.abs(nextItem.x - (currentItem.x + currentItem.width));
                    const yDistance = Math.abs(nextItem.y - currentItem.y);
                    if (xDistance < 15 && yDistance < 5) {
                        groupItem.text += nextItem.text;
                        groupItem.width = nextItem.x + nextItem.width - currentItem.x;
                        groupItem.originalIndices.push(i + 1);
                        processed.add(i + 1);
                    }
                }
                groupedItems.push(groupItem);
                processed.add(i);
            }
            return groupedItems;
        }
        
        await renderAllPages();
    } catch (error) {
        console.error('Error saving PDF:', error);
        showNotification('Error saving PDF: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function updateTextBoxes() {
    if (!pdfPage || !canvasWrapper) return;
    const pdfPageRect = pdfPage.getBoundingClientRect();
    const canvasRect = canvasWrapper.getBoundingClientRect();
    textItems.forEach((item) => {
        const textBox = textBoxes.find(box => box && parseInt(box.dataset.index) === item.originalIndex);
        if (textBox) {
            textBox.style.left = ((canvasRect.left - pdfPageRect.left) + item.x) + 'px';
            textBox.style.top = ((canvasRect.top - pdfPageRect.top) + (item.y - item.height)) + 'px';
            textBox.style.width = item.width + 'px';
            textBox.style.height = item.height + 'px';
            textBox.title = item.text;
        }
    });
}

function updatePageInfo() {
    const pageInfo = document.getElementById('page-info');
    const prevPage = document.getElementById('prev-page');
    const nextPage = document.getElementById('next-page');
    if (pageInfo) pageInfo.textContent = `Page ${pageNum} of ${pageCount}`;
    if (prevPage) prevPage.disabled = pageNum <= 1;
    if (nextPage) nextPage.disabled = pageNum >= pageCount;
}

function updateZoomLevel() {
    const zoomLevel = document.getElementById('zoom-level');
    if (zoomLevel) zoomLevel.textContent = Math.round(scale * 100) + '%';
}

// ==========================================
// MAKE EDIT DIALOG DRAGGABLE
// ==========================================
function makeDialogDraggable() {
    const dialog = document.getElementById('edit-dialog');
    if (!dialog) return;
    
    const dialogHeader = dialog.querySelector('.dialog-header');
    const minimizeBtn = document.getElementById('dialog-minimize');
    
    let isDragging = false;
    let isMinimized = false;
    let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;
    
    function loadSavedPosition() {
        const savedPos = localStorage.getItem('dialogPosition');
        if (savedPos) {
            try {
                const pos = JSON.parse(savedPos);
                dialog.style.left = pos.left;
                dialog.style.top = pos.top;
                dialog.style.transform = 'none';
                xOffset = parseInt(pos.left) || 0;
                yOffset = parseInt(pos.top) || 0;
            } catch (e) {}
        }
    }
    
    function savePosition() {
        localStorage.setItem('dialogPosition', JSON.stringify({ left: dialog.style.left, top: dialog.style.top }));
    }
    
    dialog.style.position = 'fixed';
    loadSavedPosition();
    
    dialogHeader.addEventListener('mousedown', (e) => {
        if (e.target === minimizeBtn) return;
        isDragging = true;
        const rect = dialog.getBoundingClientRect();
        xOffset = rect.left;
        yOffset = rect.top;
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
        dialog.style.transition = 'none';
        e.preventDefault();
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            dialog.style.transition = 'all 0.1s ease';
            savePosition();
        }
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        const maxX = window.innerWidth - dialog.offsetWidth;
        const maxY = window.innerHeight - dialog.offsetHeight;
        currentX = Math.min(Math.max(0, currentX), maxX);
        currentY = Math.min(Math.max(0, currentY), maxY);
        dialog.style.left = currentX + 'px';
        dialog.style.top = currentY + 'px';
        dialog.style.transform = 'none';
    });
    
    if (minimizeBtn) {
        minimizeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            isMinimized = !isMinimized;
            const controls = dialog.querySelectorAll('.edit-controls');
            const input = dialog.querySelector('#dialog-input');
            const buttons = dialog.querySelector('.dialog-buttons');
            if (isMinimized) {
                controls.forEach(c => c.style.display = 'none');
                if (input) input.style.display = 'none';
                if (buttons) buttons.style.display = 'none';
                dialog.style.minWidth = '200px';
                minimizeBtn.textContent = 'â–¡';
            } else {
                controls.forEach(c => c.style.display = 'flex');
                if (input) input.style.display = 'block';
                if (buttons) buttons.style.display = 'flex';
                dialog.style.minWidth = '550px';
                minimizeBtn.textContent = 'âˆ’';
            }
        });
    }
}

// ==========================================
// KEYBOARD SHORTCUTS
// ==========================================
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') { e.preventDefault(); if (auth.currentUser && pdfDoc) savePDF(); }
    if (e.ctrlKey && e.key === 'o') { e.preventDefault(); if (auth.currentUser) pdfFileInput.click(); }
    if (e.key === 'Escape' && editDialog && editDialog.style.display === 'block') closeDialog();
});

// ==========================================
// TOUCH SUPPORT
// ==========================================
let touchStartX, touchStartY;
if (pdfContainer) {
    pdfContainer.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; });
    pdfContainer.addEventListener('touchend', (e) => {
        if (!touchStartX) return;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (diffX > 0 && pageNum < pageCount) { pageNum++; renderPage(pageNum); }
            else if (diffX < 0 && pageNum > 1) { pageNum--; renderPage(pageNum); }
        }
    });
}

// ==========================================
// GLOBAL ERROR HANDLERS
// ==========================================
window.addEventListener('error', function(e) { console.error('Global error:', e.error); showNotification('An error occurred: ' + e.message); showLoading(false); return false; });
window.addEventListener('unhandledrejection', function(e) { console.error('Unhandled rejection:', e.reason); showNotification('An error occurred: ' + e.reason.message); showLoading(false); });

// ==========================================
// UPDATE USER DASHBOARD
// ==========================================
function updateUserDashboard(userData) {
    const dashboard = document.getElementById('user-dashboard');
    const loginForm = document.getElementById('login-form');
    const loginHeader = document.getElementById('login-header');
    const userEmail = document.getElementById('user-email');
    const userAvatar = document.getElementById('user-avatar');
    const userPlan = document.getElementById('user-plan');
    const dashboardPlanBadge = document.getElementById('dashboard-plan-badge');
    
    if (!userData) {
        dashboard.style.display = 'none';
        loginForm.style.display = 'block';
        loginHeader.innerHTML = '<h2><i class="fas fa-lock"></i> Login Required</h2><p>Please login to access PDF Form Editor</p>';
        return;
    }
    
    dashboard.style.display = 'block';
    loginForm.style.display = 'none';
    loginHeader.innerHTML = '<h2><i class="fas fa-hand-peace"></i> Welcome Back!</h2><p>Manage your account</p>';
    userEmail.textContent = userData.email || 'User';
    userAvatar.textContent = userData.email ? userData.email.charAt(0).toUpperCase() : 'U';
    
    const used = userData.editCount || 0;
    const total = userData.maxEdits || 2;
    const remaining = total - used;
    const progressPercent = (used / total) * 100;
    
    document.getElementById('dashboard-used').textContent = used;
    document.getElementById('dashboard-total').textContent = total;
    document.getElementById('dashboard-remaining').textContent = remaining;
    document.getElementById('dashboard-used-count').textContent = used;
    document.getElementById('dashboard-progress').style.width = progressPercent + '%';
    document.getElementById('dashboard-edits').textContent = used;
    
    if (pdfDoc) document.getElementById('dashboard-pages').textContent = pageCount;
    else document.getElementById('dashboard-pages').textContent = '0';
    
    if (userData.email === 'arun@gmail.com') {
        userPlan.textContent = 'Admin Plan';
        dashboardPlanBadge.textContent = 'Admin';
    } else {
        userPlan.textContent = 'Free Plan';
        dashboardPlanBadge.textContent = 'Free';
    }
}

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    createProfessionalDialog();
    startConnectionMonitoring();
    makeDialogDraggable();
    
    const loginModal = document.getElementById('login-modal');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const logoutButtonInside = document.getElementById('logout-button-inside');
    const closeLogin = document.getElementById('close-login');
    const loginStatusBtn = document.getElementById('login-status-btn');
    const notificationCancel = document.getElementById('notification-cancel');
    
    if (notificationCancel) notificationCancel.addEventListener('click', cancelNotification);
    
    // Add Admin Panel Button
    const headerControls = document.querySelector('.header-controls');
    if (headerControls) {
        const adminBtn = document.createElement('button');
        adminBtn.className = 'save-btn';
        adminBtn.id = 'admin-panel-btn';
        adminBtn.innerHTML = '<i class="fas fa-crown"></i> Admin';
        adminBtn.style.display = 'none';
        adminBtn.addEventListener('click', showAdminPanel);
        headerControls.appendChild(adminBtn);
        
        const buyBtn = document.createElement('button');
        buyBtn.className = 'save-btn';
        buyBtn.id = 'buy-edits-btn';
        buyBtn.innerHTML = '<i class="fas fa-coins"></i> Buy Edits';
        buyBtn.addEventListener('click', showPaymentDialog);
        headerControls.insertBefore(buyBtn, document.getElementById('save-btn'));
    }
    
    document.getElementById('dashboard-buy-btn')?.addEventListener('click', showPaymentDialog);
    document.getElementById('dashboard-refresh-btn')?.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (user) {
            const snapshot = await database.ref('users/' + user.uid).once('value');
            const userData = snapshot.val() || { editCount: 0, maxEdits: 2, email: user.email };
            updateUserDashboard(userData);
            showNotification('Dashboard updated');
        }
    });
    
    auth.onAuthStateChanged(async (user) => {
        const adminBtn = document.getElementById('admin-panel-btn');
        if (user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            let userData = snapshot.val();
            if (!userData) userData = { email: user.email, editCount: 0, maxEdits: 2 };
            else userData.email = user.email;
            updateUserDashboard(userData);
            if (loginStatusBtn) loginStatusBtn.innerHTML = '<i class="fas fa-user-check"></i> ' + user.email.split('@')[0];
            if (isAdmin(user)) {
                if (loginStatusBtn) loginStatusBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                if (adminBtn) adminBtn.style.display = 'inline-flex';
                watermarkSettings.enabled = false;
            } else {
                if (loginStatusBtn) loginStatusBtn.style.background = 'linear-gradient(135deg, #059669, #047857)';
                if (adminBtn) adminBtn.style.display = 'none';
                watermarkSettings.enabled = true;
            }
            if (isOnline) enableEditing();
        } else {
            document.getElementById('user-dashboard').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('login-header').innerHTML = '<h2><i class="fas fa-lock"></i> Login Required</h2><p>Please login to access PDF Form Editor</p>';
            if (loginStatusBtn) { loginStatusBtn.innerHTML = '<i class="fas fa-user"></i> Login'; loginStatusBtn.style.background = 'linear-gradient(135deg, #2563eb, #1d4ed8)'; }
            if (adminBtn) adminBtn.style.display = 'none';
            watermarkSettings.enabled = true;
        }
    });
    
    if (loginButton) {
        loginButton.addEventListener('click', () => {
            const email = loginEmail ? loginEmail.value : '';
            const password = loginPassword ? loginPassword.value : '';
            if (!email || !password) { showNotification('Please enter email and password'); return; }
            showLoading(true);
            auth.signInWithEmailAndPassword(email, password)
                .then(() => { showNotification('Login successful!'); if (loginEmail) loginEmail.value = ''; if (loginPassword) loginPassword.value = ''; })
                .catch((error) => { let message = 'Login failed: '; if (error.code === 'auth/user-not-found') message += 'User not found'; else if (error.code === 'auth/wrong-password') message += 'Wrong password'; else message += error.message; showNotification(message, true); })
                .finally(() => showLoading(false));
        });
    }
    
    function logout() {
        auth.signOut().then(() => { showNotification('Logged out successfully'); if (loginModal) loginModal.style.display = 'flex'; }).catch((error) => { showNotification('Logout failed: ' + error.message, true); });
    }
    
    if (logoutButton) logoutButton.addEventListener('click', logout);
    if (logoutButtonInside) logoutButtonInside.addEventListener('click', logout);
    
    if (closeLogin) {
        closeLogin.addEventListener('click', () => {
            if (auth.currentUser) { if (loginModal) loginModal.style.display = 'none'; }
            else showNotification('Please login to continue');
        });
    }
    
    if (loginPassword) loginPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter' && loginButton) loginButton.click(); });
    if (loginEmail) loginEmail.addEventListener('keypress', (e) => { if (e.key === 'Enter' && loginPassword) loginPassword.focus(); });
    if (loginStatusBtn) loginStatusBtn.addEventListener('click', () => { if (loginModal) loginModal.style.display = 'flex'; });
    
    window.approvePayment = approvePayment;
    window.rejectPayment = rejectPayment;
    
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    init();
});
</script>